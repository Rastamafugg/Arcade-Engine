<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pixel Canvas — Overworld Demo</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    background: #0a0a0f;
    display: flex; align-items: center; justify-content: center;
    width: 100vw; height: 100vh; overflow: hidden;
  }
  canvas { display: block; image-rendering: pixelated; image-rendering: crisp-edges; }
  #debug {
    position: fixed; top: 8px; left: 8px;
    color: #0f0; font: 9px/1.5 monospace;
    pointer-events: none; white-space: pre;
    background: rgba(0,0,0,0.55); padding: 4px 6px; border-radius: 2px;
  }
  #hint {
    position: fixed; bottom: 10px; left: 50%; transform: translateX(-50%);
    color: #555; font: 9px monospace; white-space: pre; text-align: center;
    pointer-events: none;
  }
</style>
</head>
<body>
<canvas id="screen"></canvas>
<div id="debug"></div>
<div id="hint">WASD/ARROWS: move  |  Z/SPACE: action/dialog  |  F5: save  |  F9: load</div>

<!-- Engine must load first -->
<script src="pixel-canvas-engine.js"></script>

<script>
'use strict';

// ================================================================
// GAME DATA: SPRITES
// 8×8 flat arrays of palette indices. null = transparent.
// ================================================================
const SPRITES = {
  // ---- Terrain ----
  grass: [
     9, 9, 8, 9, 9, 9, 8, 9,   8, 9, 9, 9, 8, 9, 9, 8,
     9, 9, 8, 9, 9, 8, 9, 9,  11,11,11, 9,11,11,11,11,
    11,11,11,11,11,11,11,11,  12,11,11,11,12,11,11,12,
    11,11,12,11,11,11,12,11,  11,12,11,11,11,12,11,11,
  ],
  stone: [
    22,21,22,22,22,22,21,22,  21,22,22,22,21,22,22,22,
    22,22,22,21,22,22,22,21,  23,23,23,23,23,23,23,23,
    22,22,22,23,22,22,22,23,  22,23,22,22,22,23,22,22,
    23,22,22,22,23,22,22,22,  22,22,23,22,22,22,23,22,
  ],
  wall: [
    24,24,28,24,24,24,28,24,  28,29,29,29,29,29,29,28,
    24,29,24,24,24,24,29,24,  24,29,24,24,24,24,29,24,
    28,29,29,29,29,29,29,28,  24,29,24,24,24,24,29,24,
    24,29,24,24,24,24,29,24,  28,29,29,29,29,29,29,28,
  ],
  cave_wall: [
    30,30,29,30,30,30,29,30,  29,14,14,14,14,14,14,29,
    30,14,30,30,30,30,14,30,  30,14,30,31,31,30,14,30,
    29,14,14,14,14,14,14,29,  30,14,30,30,30,30,14,30,
    30,14,31,30,30,31,14,30,  29,14,14,14,14,14,14,29,
  ],
  cave_floor: [
    13,13,24,13,13,13,24,13,  24,13,13,13,24,13,13,24,
    13,13,24,13,13,24,13,13,  23,23,23,13,23,23,23,23,
    23,23,23,23,23,23,23,23,  13,23,23,23,13,23,23,13,
    23,13,23,23,23,13,23,23,  23,23,13,23,23,23,13,23,
  ],
  water0: [
    18,17,18,18,18,17,18,18,  18,18,17,18,18,18,17,18,
    15,18,18,18,15,18,18,18,  18,15,18,18,18,15,18,18,
    18,18,18,15,18,18,18,15,  18,18,15,18,18,18,15,18,
    17,18,18,18,17,18,18,18,  18,17,18,18,18,17,18,18,
  ],
  water1: [
    18,18,17,18,18,18,17,18,  17,18,18,18,17,18,18,18,
    18,18,18,15,18,18,18,15,  18,18,15,18,18,18,15,18,
    15,18,18,18,15,18,18,18,  18,15,18,18,18,15,18,18,
    18,18,18,17,18,18,18,17,  18,18,17,18,18,18,17,18,
  ],
  // ---- Decor ----
  tree: [
    null,null, 8,null,null, 8,null,null,
    null, 8,   8,  8,  8,  8,  8,null,
       8,  8,  8,  9,  9,  8,  8,  8,
    null, 8,   9,  8,  8,  9,  8,null,
    null,null, 8,  8,  8,  8,null,null,
    null,null,null, 3,null,null,null,null,
    null,null,null, 3,null,null,null,null,
    null,null,null,null,null,null,null,null,
  ],
  flower: [
    null,null,null, 7,null,null,null,null,
    null,null, 7,   7,  7,null,null,null,
    null,null,null, 7,null,null,null,null,
    null, 8,null,null,null, 7,null,null,
       8, 9,  8,null,null, 7,  7,null,
    null, 8,null,null,null, 7,null,null,
    null,null,null,null,null,null,null,null,
    null,null,null,null,null,null,null,null,
  ],
  crystal: [
    null,null,19,null,null,null,null,null,
    null,19,  18,  19,null,null,null,null,
      19, 18,  20,  18,  19,null,null,null,
    null,19,  18,  19,null,null,null,null,
    null,null,19,null,null,19,  18,  19,
    null,null,null,null,19, 18,  20,  18,
    null,null,null,null,null,19,null,null,
    null,null,null,null,null,null,null,null,
  ],
  portal: [
    null,null, 25, 25, 25,null,null,null,
    null, 25,  19, 18, 19,  25,null,null,
      25, 19,  18, 20, 18,  19,  25,null,
      25, 18,  20, 25, 20,  18,  25,null,
      25, 19,  18, 20, 18,  19,  25,null,
    null, 25,  19, 18, 19,  25,null,null,
    null,null, 25, 25, 25,null,null,null,
    null,null,null,null,null,null,null,null,
  ],
  // ---- NPCs ----
  npc_a: [
    null,null,  7,  7,  7,  7,null,null,
    null,  7, 24,  7,  7, 24,  7,null,
    null,  7,  7,  7,  7,  7,  7,null,
    null,  4,  4,  4,  4,  4,  4,null,
       4,  4,  5,  4,  4,  5,  4,  4,
    null,  4,  5,  5,  5,  5,  4,null,
    null,  5,null,null,null,null,  5,null,
    null,  5,null,null,null,null,  5,null,
  ],
  npc_b: [
    null,null,  5,  5,  5,  5,null,null,
    null,  5, 13,  5,  5, 13,  5,null,
    null,  5,  5,  5,  5,  5,  5,null,
    null, 27, 27, 27, 27, 27, 27,null,
      27, 27,  6, 27, 27,  6, 27, 27,
    null, 27,  6,  6,  6,  6, 27,null,
    null,  6,null,null,null,null,  6,null,
    null,  6,null,null,null,null,  6,null,
  ],
  // ---- Player ----
  player_d0: [
    null,null,  6,  6,  6,  6,null,null,
    null,  6, 24,  6,  6, 24,  6,null,
    null,  6,  6,  6,  6,  6,  6,null,
    null, 16, 16, 16, 16, 16, 16,null,
      16, 16,  5, 16, 16,  5, 16, 16,
    null, 16,  5,  5,  5,  5, 16,null,
    null,  5,  5,null,null,  5,null,null,
    null,null,  5,null,null,null,null,null,
  ],
  player_d1: [
    null,null,  6,  6,  6,  6,null,null,
    null,  6, 24,  6,  6, 24,  6,null,
    null,  6,  6,  6,  6,  6,  6,null,
    null, 16, 16, 16, 16, 16, 16,null,
      16, 16,  5, 16, 16,  5, 16, 16,
    null, 16,  5,  5,  5,  5, 16,null,
    null,null,null,null,  5,  5,null,null,
    null,null,null,null,null,  5,null,null,
  ],
  player_idle: [
    null,null,  6,  6,  6,  6,null,null,
    null,  6, 24,  6,  6, 24,  6,null,
    null,  6,  6,  6,  6,  6,  6,null,
    null, 16, 16, 16, 16, 16, 16,null,
      16, 16,  5, 16, 16,  5, 16, 16,
    null, 16,  5,  5,  5,  5, 16,null,
    null,  5,null,null,null,null,  5,null,
    null,  5,null,null,null,null,  5,null,
  ],
  player_u0: [
    null,null,  6,  6,  6,  6,null,null,
    null,  6,  6, 24, 24,  6,  6,null,
    null,  6,  6,  6,  6,  6,  6,null,
    null, 16, 16, 16, 16, 16, 16,null,
      16, 16,  5, 16, 16,  5, 16, 16,
    null, 16,  5,  5,  5,  5, 16,null,
    null,  5,  5,null,null,  5,null,null,
    null,null,  5,null,null,null,null,null,
  ],
  player_u1: [
    null,null,  6,  6,  6,  6,null,null,
    null,  6,  6, 24, 24,  6,  6,null,
    null,  6,  6,  6,  6,  6,  6,null,
    null, 16, 16, 16, 16, 16, 16,null,
      16, 16,  5, 16, 16,  5, 16, 16,
    null, 16,  5,  5,  5,  5, 16,null,
    null,null,null,null,  5,  5,null,null,
    null,null,null,null,null,  5,null,null,
  ],
  player_s0: [
    null,null,  6,  6,  6,null,null,null,
    null,  6, 24,  6,  6,  6,null,null,
    null,  6,  6,  6,  6,  6,null,null,
    null, 16, 16, 16, 16, 16, 16,null,
    null, 16,  5, 16, 16,  5, 16,null,
    null, 16,  5,  5,  5,  5,null,null,
    null,  5,  5,null,  5,null,null,null,
    null,null,  5,null,null,null,null,null,
  ],
  player_s1: [
    null,null,  6,  6,  6,null,null,null,
    null,  6, 24,  6,  6,  6,null,null,
    null,  6,  6,  6,  6,  6,null,null,
    null, 16, 16, 16, 16, 16, 16,null,
    null, 16,  5, 16, 16,  5, 16,null,
    null, 16,  5,  5,  5,  5,null,null,
    null,null,null,  5,  5,null,null,null,
    null,null,null,null,  5,null,null,null,
  ],
};

buildSpriteCache(SPRITES);

// ================================================================
// TILE ANIMATIONS
// ================================================================
registerTileAnims({
  water: { frames: ['water0','water1'], fps: 2 },
});

// ================================================================
// SOUND DATA
// ================================================================
sound.registerTracks({
  overworld: {
    bpm: 140, loop: true,
    channels: [
      { instrument: 'square',
        notes: 'E5:0.5 G5:0.5 A5:1 E5:0.5 G5:0.5 B5:1 A5:0.5 G5:0.5 A5:0.5 E5:0.5 D5:2 R:1 C5:0.5 E5:0.5 G5:0.5 A5:1 F5:0.5 E5:0.5 D5:0.5 C5:0.5 E5:2 R:1' },
      { instrument: 'triangle',
        notes: 'A3:2 A3:2 F3:2 G3:2 A3:2 A3:2 G3:2 E3:2 C3:2 E3:2 F3:2 G3:2 A3:4' },
    ],
  },
  cave: {
    bpm: 70, loop: true,
    channels: [
      { instrument: 'sine',
        notes: 'A3:2 R:1 G3:1 F3:2 R:1 E3:1 D3:2 R:2 A2:4 R:2 E3:2 R:2 F3:2 R:2' },
      { instrument: 'triangle',
        notes: 'A2:4 R:4 F2:4 R:4 G2:4 R:4 A2:8 R:4' },
    ],
  },
});

sound.registerSFX({
  confirm: { bpm:960, channels:[{ instrument:'square',   notes:'C5:0.1 E5:0.1 G5:0.2' }] },
  dialog:  { bpm:960, channels:[{ instrument:'square',   notes:'C6:0.05' }] },
  portal:  { bpm:480, channels:[{ instrument:'sine',     notes:'A4:0.1 C#5:0.1 E5:0.1 A5:0.2 R:0.1 A6:0.3' }] },
  save:    { bpm:960, channels:[{ instrument:'square',   notes:'G5:0.08 B5:0.08 D6:0.08 G6:0.15' }] },
  cancel:  { bpm:960, channels:[{ instrument:'triangle', notes:'E5:0.1 C5:0.1' }] },
});

// ================================================================
// ANIMATION CLIPS
// ================================================================
const CLIPS_PLAYER = {
  idle:      { frames: ['player_idle'],           durations: 0.2  },
  walk_down: { frames: ['player_d0','player_d1'], durations: 0.18 },
  walk_up:   { frames: ['player_u0','player_u1'], durations: 0.18 },
  walk_side: { frames: ['player_s0','player_s1'], durations: 0.18 },
};

setNpcClipFactory(sprite => ({
  idle:      { frames: [sprite], durations: 0.4 },
  walk_down: { frames: [sprite], durations: 0.3 },
  walk_up:   { frames: [sprite], durations: 0.3 },
  walk_side: { frames: [sprite], durations: 0.3 },
}));

// ================================================================
// SCENE DEFINITIONS
// ================================================================
function buildOverworld(cols, rows) {
  const bg  = Array.from({length: rows}, () => Array(cols).fill('grass'));
  const obj = Array.from({length: rows}, () => Array(cols).fill(null));
  const col = Array.from({length: rows}, () => Array(cols).fill(false));

  for (let r = 4; r <= 6; r++)
    for (let c = 5; c <= 9; c++) { bg[r][c] = 'water'; col[r][c] = true; }

  for (let r = 9; r <= 11; r++)
    for (let c = 6; c <= 10; c++) bg[r][c] = 'stone';

  for (let r = 20; r <= 25; r++)
    for (let c = 15; c <= 22; c++)
      if (r === 20 || r === 25 || c === 15 || c === 22)
        { obj[r][c] = 'wall'; col[r][c] = true; }

  [[1,1],[1,4],[2,8],[3,18],[6,14],[0,12],[9,25],[11,28],[16,5],[13,8],[22,2],[24,6],
   [5,32],[12,38],[20,30],[28,5],[30,12],[32,20],[25,35]].forEach(([r,c]) => {
    if (r < rows && c < cols) { obj[r][c] = 'tree'; col[r][c] = true; }
  });
  [[3,3],[4,12],[7,3],[8,18],[13,7],[19,12],[22,28],[28,15]].forEach(([r,c]) => {
    if (r < rows && c < cols) obj[r][c] = 'flower';
  });
  obj[8][35] = 'portal';
  return { bg, objects: obj, collision: col };
}

function buildCave(cols, rows) {
  const bg  = Array.from({length: rows}, (_, r) =>
    Array.from({length: cols}, (_, c) =>
      (r === 0 || r === rows-1 || c === 0 || c === cols-1) ? 'cave_wall' : 'cave_floor'));
  const obj = Array.from({length: rows}, () => Array(cols).fill(null));
  const col = Array.from({length: rows}, (_, r) =>
    Array.from({length: cols}, (_, c) =>
      r === 0 || r === rows-1 || c === 0 || c === cols-1));

  for (let r = 4; r <= 12; r++)
    for (let c = 5; c <= 14; c++)
      if ((r === 4 || r === 12 || c === 5 || c === 14) &&
          !(r === 8 && (c === 5 || c === 14)))
        { bg[r][c] = 'cave_wall'; col[r][c] = true; }

  [[2,5],[2,10],[2,16],[16,3],[16,10],[16,16],[6,8],[9,11],[7,2],[14,17]].forEach(([r,c]) => {
    if (r < rows && c < cols && !col[r][c]) obj[r][c] = 'crystal';
  });
  obj[8][1] = 'portal'; col[8][1] = false; bg[8][0] = 'cave_floor'; col[8][0] = false;
  return { bg, objects: obj, collision: col };
}

const SCENES_DATA = {
  overworld: (() => {
    const cols = 40, rows = 36;
    const { bg, objects, collision } = buildOverworld(cols, rows);
    return {
      worldCols: cols, worldRows: rows, bgColor: 0,
      playerStart: { tileX: 15, tileY: 15 },
      music: 'overworld',
      layerBG: bg, layerObjects: objects, layerCollision: collision,
      portals: [
        { tileX: 35, tileY: 8, targetScene: 'cave', targetTileX: 3, targetTileY: 8 },
      ],
      npcs: [
        {
          tileX: 12, tileY: 12, sprite: 'npc_a', name: 'VILLAGER',
          dialog: [
            'GREETINGS, TRAVELER!\nWELCOME TO OUR VILLAGE.',
            'THE CRYSTAL CAVE LIES\nTO THE EAST. A GLOWING\nPORTAL MARKS THE WAY.',
            'FEW WHO ENTER RETURN\nTO TELL THE TALE...',
          ],
          patrol: {
            speed: 20, waypointIdx: 0,
            waypoints: [{x:12*8,y:12*8},{x:15*8,y:12*8},{x:15*8,y:15*8},{x:12*8,y:15*8}],
          },
        },
        {
          tileX: 7, tileY: 10, sprite: 'npc_b', name: 'SCHOLAR',
          dialog: [
            'AH, A NEW FACE!',
            'PRESS Z NEAR ANY NPC\nTO SPEAK WITH THEM.',
            'PRESS F5 TO SAVE.\nPRESS F9 TO LOAD.',
          ],
          patrol: null,
        },
      ],
    };
  })(),

  cave: (() => {
    const cols = 20, rows = 18;
    const { bg, objects, collision } = buildCave(cols, rows);
    return {
      worldCols: cols, worldRows: rows, bgColor: 30,
      playerStart: { tileX: 3, tileY: 8 },
      music: 'cave',
      layerBG: bg, layerObjects: objects, layerCollision: collision,
      portals: [
        { tileX: 1, tileY: 8, targetScene: 'overworld', targetTileX: 34, targetTileY: 8 },
      ],
      npcs: [
        {
          tileX: 12, tileY: 8, sprite: 'npc_b', name: 'CAVE SAGE',
          dialog: [
            'YOU HAVE ENTERED THE\nCRYSTAL CAVE.',
            'THE CRYSTALS HERE HAVE\nPULSED FOR CENTURIES.',
            'RETURN THE WAY YOU\nCAME TO LEAVE.\nSAFE TRAVELS.',
          ],
          patrol: null,
        },
      ],
    };
  })(),
};

registerScenes(SCENES_DATA);
setSaveKey('pixelCanvas_overworld_v1');

// ================================================================
// ENTITY INIT
// ================================================================
playerId = world.createEntity({
  persistent: true,
  player:     true,
  transform:  { x: 15 * TILE_SIZE, y: 15 * TILE_SIZE },
  velocity:   { dx: 0, dy: 0, speed: 60 },
  animator:   createAnimator(CLIPS_PLAYER, 'idle'),
  collider:   true,
});

// ================================================================
// MAIN LOOP
// ================================================================
let elapsed = 0, lastTime = 0;
let fps = 0, fpsTimer = 0, fpsFrames = 0;

loadScene('overworld');
if (saveLoad.hasSave()) { if (saveLoad.load()) showNote('SAVE LOADED'); }

function loop(ts) {
  const delta = Math.min((ts - lastTime) / 1000, 0.05);
  lastTime = ts; elapsed += delta;
  fpsFrames++; fpsTimer += delta;
  if (fpsTimer >= 0.5) { fps = Math.round(fpsFrames / fpsTimer); fpsTimer = fpsFrames = 0; }

  engineTick(delta);
  updateTransition(delta);

  // --- Logic ---
  input.update();
  sysInput();
  sysAI(delta);
  sysMovement(delta);
  sysSpatialHash();
  sysCamera();
  sysSceneTransition();
  sysAnimation(delta);
  sysDialog(elapsed);

  // --- Render ---
  clearBuffer(SCENES_DATA[worldState.currentScene]?.bgColor ?? 0);
  drawTilemap(worldState.layerBG,      elapsed);
  drawTilemap(worldState.layerObjects, elapsed);
  sysRender();
  renderDialog(elapsed);
  renderSaveNote();
  flushBuffer();
  renderTransitionOverlay();

  const ptf = world.get(playerId, 'transform');
  document.getElementById('debug').textContent =
    `FPS: ${fps}  SCENE: ${worldState.currentScene}\n` +
    `PLAYER: ${ptf?.x|0},${ptf?.y|0}  TILE: ${ptf?.x/TILE_SIZE|0},${ptf?.y/TILE_SIZE|0}\n` +
    `CAM: ${camera.x},${camera.y}  WORLD: ${worldState.w}x${worldState.h}px\n` +
    `ENTITIES: ${[...world.allIds].length}  DIALOG: ${dialog.active}`;

  requestAnimationFrame(loop);
}

requestAnimationFrame(loop);
</script>
</body>
</html>
