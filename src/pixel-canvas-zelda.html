<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pixel Canvas v5.1 — Overworld Demo (Enhanced)</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    background: #0a0a0f;
    display: flex; align-items: center; justify-content: center;
    width: 100vw; height: 100vh; overflow: hidden;
  }
  canvas { display: block; image-rendering: pixelated; image-rendering: crisp-edges; }
  #debug {
    position: fixed; top: 8px; left: 8px;
    color: #0f0; font: 9px/1.5 monospace; pointer-events: none; white-space: pre;
    background: rgba(0,0,0,0.55); padding: 4px 6px; border-radius: 2px;
  }
  #hint {
    position: fixed; bottom: 10px; left: 50%; transform: translateX(-50%);
    color: #555; font: 9px monospace; white-space: pre; text-align: center;
    pointer-events: none;
  }
</style>
</head>
<body>
<canvas id="screen"></canvas>
<div id="debug"></div>
<div id="hint">WASD: move  |  Z: talk/open/use item  |  X: attack  |  E/Q: cycle items  |  M: minimap  |  F5: save  |  F9: load</div>


<script type="module">
import * as Engine from './pixelGameEngine/index.js';

const {
  // Config
  TILE_SIZE,
  // Assets
  buildSpriteCache, buildPaletteSwap,
  // World / Tilemap
  worldState, camera, registerTileAnims, drawTilemap,
  // Renderer
  clearBuffer, flushBuffer, fillRectPx, fillRectWorld, drawText, drawBox, blendPixel,
  // Physics
  spatialHash,
  // ECS
  world,
  // Input
  input,
  // Sound
  sound,
  // Animation
  createAnimator, animatorPlay, animatorUpdate, animatorSprite,
  // Particles
  emitBurst, updateParticles, renderParticles,
  // Scene
  getPlayerId, setPlayerId, registerScenes, loadScene, clearSceneEntities,
  setNpcClipFactory, spawnSceneNpcs, spawnSceneChests, updateTransition,
  // Flags
  setFlag, clearFlag, getFlag, hasFlags, onFlags,
  // Dialog
  dialog, sysDialog, renderDialog,
  // Cutscene
  cutscene,
  // Combat
  sysSwing, sysProjectile, sysDamage, spawnAttack,
  // Enemy
  sysEnemy, spawnRangedEnemy,
  // Spawner
  createSpawner, sysSpawner,
  // Chest
  sysChestLoot,
  // Save/Load
  renderSaveNote, showNote, setSaveKey, saveLoad,
  // Game loop systems
  engineTick, sysInput, sysAI, sysMovement, sysSpatialHash,
  sysAnimation, sysCamera, sysSceneTransition, sysRender,
  // HUD
  hud, renderHUD,
  // Minimap
  renderMinimap,
  // Transition
  renderTransitionOverlay,
  // Scene exports (re-exported from scene.js)
  getScenes, sceneTransition,
} = Engine;

'use strict';

// ================================================================
// SPRITES
// ================================================================
const SPRITES = {
  // ---- Terrain ----
  grass: [
     9, 9, 8, 9, 9, 9, 8, 9,   8, 9, 9, 9, 8, 9, 9, 8,
     9, 9, 8, 9, 9, 8, 9, 9,  11,11,11, 9,11,11,11,11,
    11,11,11,11,11,11,11,11,  12,11,11,11,12,11,11,12,
    11,11,12,11,11,11,12,11,  11,12,11,11,11,12,11,11,
  ],
  stone: [
    22,21,22,22,22,22,21,22,  21,22,22,22,21,22,22,22,
    22,22,22,21,22,22,22,21,  23,23,23,23,23,23,23,23,
    22,22,22,23,22,22,22,23,  22,23,22,22,22,23,22,22,
    23,22,22,22,23,22,22,22,  22,22,23,22,22,22,23,22,
  ],
  wall: [
    24,24,28,24,24,24,28,24,  28,29,29,29,29,29,29,28,
    24,29,24,24,24,24,29,24,  24,29,24,24,24,24,29,24,
    28,29,29,29,29,29,29,28,  24,29,24,24,24,24,29,24,
    24,29,24,24,24,24,29,24,  28,29,29,29,29,29,29,28,
  ],
  cave_wall: [
    30,30,29,30,30,30,29,30,  29,14,14,14,14,14,14,29,
    30,14,30,30,30,30,14,30,  30,14,30,31,31,30,14,30,
    29,14,14,14,14,14,14,29,  30,14,30,30,30,30,14,30,
    30,14,31,30,30,31,14,30,  29,14,14,14,14,14,14,29,
  ],
  cave_floor: [
    13,13,24,13,13,13,24,13,  24,13,13,13,24,13,13,24,
    13,13,24,13,13,24,13,13,  23,23,23,13,23,23,23,23,
    23,23,23,23,23,23,23,23,  13,23,23,23,13,23,23,13,
    23,13,23,23,23,13,23,23,  23,23,13,23,23,23,13,23,
  ],
  // Deeper cave floor — slightly darker stone
  cave_floor_b2: [
    30,30,29,30,30,30,30,30,  30,30,30,30,29,30,30,30,
    30,30,30,29,30,30,30,30,  23,23,23,30,23,23,23,23,
    23,23,23,23,23,23,23,23,  30,23,23,23,30,23,23,30,
    23,30,23,23,23,30,23,23,  23,23,30,23,23,23,30,23,
  ],
  // Deepest cave floor
  cave_floor_b3: [
    14,14,30,14,14,14,14,14,  14,14,14,14,30,14,14,14,
    14,14,14,30,14,14,14,14,  30,30,30,14,30,30,30,30,
    30,30,30,30,30,30,30,30,  14,30,30,30,14,30,30,14,
    30,14,30,30,30,14,30,30,  30,30,14,30,30,30,14,30,
  ],
  water0: [
    18,17,18,18,18,17,18,18,  18,18,17,18,18,18,17,18,
    15,18,18,18,15,18,18,18,  18,15,18,18,18,15,18,18,
    18,18,18,15,18,18,18,15,  18,18,15,18,18,18,15,18,
    17,18,18,18,17,18,18,18,  18,17,18,18,18,17,18,18,
  ],
  water1: [
    18,18,17,18,18,18,17,18,  17,18,18,18,17,18,18,18,
    18,18,18,15,18,18,18,15,  18,18,15,18,18,18,15,18,
    15,18,18,18,15,18,18,18,  18,15,18,18,18,15,18,18,
    18,18,18,17,18,18,18,17,  18,18,17,18,18,18,17,18,
  ],
  // ---- Decor ----
  tree: [
    null,null, 8,null,null, 8,null,null,
    null, 8,   8,  8,  8,  8,  8,null,
       8,  8,  8,  9,  9,  8,  8,  8,
    null, 8,   9,  8,  8,  9,  8,null,
    null,null, 8,  8,  8,  8,null,null,
    null,null,null, 3,null,null,null,null,
    null,null,null, 3,null,null,null,null,
    null,null,null,null,null,null,null,null,
  ],
  flower: [
    null,null,null, 7,null,null,null,null,
    null,null, 7,   7,  7,null,null,null,
    null,null,null, 7,null,null,null,null,
    null, 8,null,null,null, 7,null,null,
       8, 9,  8,null,null, 7,  7,null,
    null, 8,null,null,null, 7,null,null,
    null,null,null,null,null,null,null,null,
    null,null,null,null,null,null,null,null,
  ],
  crystal: [
    null,null,19,null,null,null,null,null,
    null,19,  18,  19,null,null,null,null,
      19, 18,  20,  18,  19,null,null,null,
    null,19,  18,  19,null,null,null,null,
    null,null,19,null,null,19,  18,  19,
    null,null,null,null,19, 18,  20,  18,
    null,null,null,null,null,19,null,null,
    null,null,null,null,null,null,null,null,
  ],
  portal: [
    null,null,25,25,25,null,null,null,
    null,25,  19,18,19,  25,null,null,
      25,19,  18,20,18,  19,  25,null,
      25,18,  20,25,20,  18,  25,null,
      25,19,  18,20,18,  19,  25,null,
    null,25,  19,18,19,  25,null,null,
    null,null,25,25,25,null,null,null,
    null,null,null,null,null,null,null,null,
  ],
  // Stair portals
  stairs_down: [
    20,20,20,20,20,20,20,20,
    null,22,22,22,22,22,22,22,
    null,null,22,22,22,22,22,22,
    null,null,null,22,22,22,22,22,
    null,null,null,null,22,22,22,22,
    null,null,null,null,null,22,22,22,
    null,null,null,null,null,null,22,22,
    null,null,null,null,null,null,null,22,
  ],
  stairs_up: [
    22,null,null,null,null,null,null,null,
    22,22,null,null,null,null,null,null,
    22,22,22,null,null,null,null,null,
    22,22,22,22,null,null,null,null,
    22,22,22,22,22,null,null,null,
    22,22,22,22,22,22,null,null,
    22,22,22,22,22,22,22,null,
    20,20,20,20,20,20,20,20,
  ],
  // ---- Items ----
  coin_item: [
    null,null, 7, 7, 7, 7,null,null,
    null, 7,  20, 7, 7, 7, 7,null,
     7,  20,  7, 7, 7, 7, 7, 7,
     7,   7,  7, 7, 7, 7, 7, 7,
     7,   7,  7, 7, 7, 7, 7, 7,
    null, 7,  7, 7, 7, 7, 7,null,
    null,null, 7, 7, 7, 7,null,null,
    null,null,null,null,null,null,null,null,
  ],
  heart_item: [
    null,27,27,null,null,27,27,null,
    27,27,27,27,27,27,27,27,
    27,27,27,27,27,27,27,27,
    27,27,27,27,27,27,27,27,
    null,27,27,27,27,27,27,null,
    null,null,27,27,27,27,null,null,
    null,null,null,27,27,null,null,null,
    null,null,null,null,null,null,null,null,
  ],
  key_item: [
    null,null, 7, 7,null,null,null,null,
    null, 7,   5, 5, 7,null,null,null,
    null, 7,   5, 5, 7,null,null,null,
    null,null, 7, 7,null, 5,null,null,
    null,null,null, 7, 5, 5, 5,null,
    null,null,null, 7,null, 5,null,null,
    null,null,null, 7,null,null,null,null,
    null,null,null,null,null,null,null,null,
  ],
  bomb_item: [
    null,null,null, 3,null,null,null,null,
    null,null, 2,   2, 3,null,null,null,
    null, 2,  26,  26,  2,null,null,null,
     2,  26,  27,  26,  26,  2,null,null,
     2,  26,  26,  26,  26,  2,null,null,
    null, 2,  26,  26,  2,null,null,null,
    null,null, 2,   2,null,null,null,null,
    null,null,null,null,null,null,null,null,
  ],
  potion_item: [
    null,null,null,20,20,null,null,null,
    null,null,20, 20,20, 20,null,null,
    null,null,20, 18,18, 20,null,null,
    null,20,  18, 18,18,  18,20,null,
    null,20,  18, 18,18,  18,20,null,
    null,20,  18, 18,18,  18,20,null,
    null,null,20, 20,20, 20,null,null,
    null,null,null,20,20,null,null,null,
  ],
  // ---- Weapon pickups ----
  sword_item: [
    null,null,null,null,null,null, 7, 7,
    null,null,null,null,null,20,20,null,
    null,null,null,null,20,22,null,null,
    null,null,null,20,22,null,null,null,
    null,null,20,22,null, 3,null,null,
    null,20,22,null, 3,null,null,null,
    20,null,null, 3,null,null,null,null,
    null,null,null,null,null,null,null,null,
  ],
  bow_item: [
    null,null, 3,null,null,null,null,null,
    null, 3,null, 3,null,null,null,null,
       3,null,null, 3,null,null,null,null,
       3,null,null,null, 3,null, 7,null,
       3,null,null,null, 3, 7, 7,null,
       3,null,null, 3, 7,null,null,null,
    null, 3,null, 3,null,null,null,null,
    null,null, 3,null,null,null,null,null,
  ],
  axe_item: [
    null,null,22,22,null,null,null,null,
    null,22,21,21,22,null,null,null,
    22,21,21,21,21,22,null,null,
    22,21,22,22,21,22,null,null,
    null,22,null,null, 3,null,null,null,
    null,null,null, 3,null,null,null,null,
    null,null, 3,null,null,null,null,null,
    null, 3,null,null,null,null,null,null,
  ],
  shield_item: [
    null, 5, 5, 5, 5, 5,null,null,
       5,18,18,18,18,18, 5,null,
       5,18,20,18,20,18, 5,null,
       5,18,18,18,18,18, 5,null,
       5,18,18,18,18,18, 5,null,
    null, 5,18,18,18, 5,null,null,
    null,null, 5,18, 5,null,null,null,
    null,null,null, 5,null,null,null,null,
  ],
  // ---- Combat sprites ----
  sword_swing: [
    null,null,null,null,null, 7,20,null,
    null,null,null,null, 7,20,null,null,
    null,null,null, 7,20,null,null,null,
    null,null, 7,20,null,null,null,null,
    null, 7,20,null,null,null,null,null,
    null,null,null,null,null,null,null,null,
    null,null,null,null,null,null,null,null,
    null,null,null,null,null,null,null,null,
  ],
  arrow_proj: [
    null,null,null,null,null,null,null,null,
    null,null,null,null,null,null,null,null,
    null,null,null,null,null,null,null, 7,
    null, 3, 3, 3, 3, 3, 3, 3,
    null,null,null,null,null,null,null, 7,
    null,null,null,null,null,null,null,null,
    null,null,null,null,null,null,null,null,
    null,null,null,null,null,null,null,null,
  ],
  // ---- NPCs ----
  npc_a: [
    null,null,  7,  7,  7,  7,null,null,
    null,  7, 24,  7,  7, 24,  7,null,
    null,  7,  7,  7,  7,  7,  7,null,
    null,  4,  4,  4,  4,  4,  4,null,
       4,  4,  5,  4,  4,  5,  4,  4,
    null,  4,  5,  5,  5,  5,  4,null,
    null,  5,null,null,null,null,  5,null,
    null,  5,null,null,null,null,  5,null,
  ],
  npc_b: [
    null,null,  5,  5,  5,  5,null,null,
    null,  5, 13,  5,  5, 13,  5,null,
    null,  5,  5,  5,  5,  5,  5,null,
    null, 27, 27, 27, 27, 27, 27,null,
      27, 27,  6, 27, 27,  6, 27, 27,
    null, 27,  6,  6,  6,  6, 27,null,
    null,  6,null,null,null,null,  6,null,
    null,  6,null,null,null,null,  6,null,
  ],
  // ---- Player ----
  player_d0: [
    null,null,  6,  6,  6,  6,null,null,
    null,  6, 24,  6,  6, 24,  6,null,
    null,  6,  6,  6,  6,  6,  6,null,
    null, 16, 16, 16, 16, 16, 16,null,
      16, 16,  5, 16, 16,  5, 16, 16,
    null, 16,  5,  5,  5,  5, 16,null,
    null,  5,  5,null,null,  5,null,null,
    null,null,  5,null,null,null,null,null,
  ],
  player_d1: [
    null,null,  6,  6,  6,  6,null,null,
    null,  6, 24,  6,  6, 24,  6,null,
    null,  6,  6,  6,  6,  6,  6,null,
    null, 16, 16, 16, 16, 16, 16,null,
      16, 16,  5, 16, 16,  5, 16, 16,
    null, 16,  5,  5,  5,  5, 16,null,
    null,null,null,null,  5,  5,null,null,
    null,null,null,null,null,  5,null,null,
  ],
  player_idle: [
    null,null,  6,  6,  6,  6,null,null,
    null,  6, 24,  6,  6, 24,  6,null,
    null,  6,  6,  6,  6,  6,  6,null,
    null, 16, 16, 16, 16, 16, 16,null,
      16, 16,  5, 16, 16,  5, 16, 16,
    null, 16,  5,  5,  5,  5, 16,null,
    null,  5,null,null,null,null,  5,null,
    null,  5,null,null,null,null,  5,null,
  ],
  player_u0: [
    null,null,  6,  6,  6,  6,null,null,
    null,  6,  6, 24, 24,  6,  6,null,
    null,  6,  6,  6,  6,  6,  6,null,
    null, 16, 16, 16, 16, 16, 16,null,
      16, 16,  5, 16, 16,  5, 16, 16,
    null, 16,  5,  5,  5,  5, 16,null,
    null,  5,  5,null,null,  5,null,null,
    null,null,  5,null,null,null,null,null,
  ],
  player_u1: [
    null,null,  6,  6,  6,  6,null,null,
    null,  6,  6, 24, 24,  6,  6,null,
    null,  6,  6,  6,  6,  6,  6,null,
    null, 16, 16, 16, 16, 16, 16,null,
      16, 16,  5, 16, 16,  5, 16, 16,
    null, 16,  5,  5,  5,  5, 16,null,
    null,null,null,null,  5,  5,null,null,
    null,null,null,null,null,  5,null,null,
  ],
  player_s0: [
    null,null,  6,  6,  6,null,null,null,
    null,  6, 24,  6,  6,  6,null,null,
    null,  6,  6,  6,  6,  6,null,null,
    null, 16, 16, 16, 16, 16, 16,null,
    null, 16,  5, 16, 16,  5, 16,null,
    null, 16,  5,  5,  5,  5,null,null,
    null,  5,  5,null,  5,null,null,null,
    null,null,  5,null,null,null,null,null,
  ],
  player_s1: [
    null,null,  6,  6,  6,null,null,null,
    null,  6, 24,  6,  6,  6,null,null,
    null,  6,  6,  6,  6,  6,null,null,
    null, 16, 16, 16, 16, 16, 16,null,
    null, 16,  5, 16, 16,  5, 16,null,
    null, 16,  5,  5,  5,  5,null,null,
    null,null,null,  5,  5,null,null,null,
    null,null,null,null,  5,null,null,null,
  ],
  // ---- Enemies ----
  // Slime (cave level 1) — green blob
  slime_0: [
    null,null, 9, 9, 9, 9,null,null,
    null, 9,  9, 9, 9, 9, 9,null,
       9, 9, 11, 9,24, 9,11, 9,
       9, 9,  9, 9, 9, 9, 9, 9,
       9, 9,  9, 9, 9, 9, 9, 9,
       9,11,  9, 9, 9, 9,11, 9,
    null, 9,  9, 9, 9, 9, 9,null,
    null,null, 9,null,null, 9,null,null,
  ],
  slime_1: [
    null,null,null,null,null,null,null,null,
    null, 9, 9, 9, 9, 9, 9,null,
       9, 9,11, 9,24, 9,11, 9,
       9, 9, 9, 9, 9, 9, 9, 9,
       9, 9, 9, 9, 9, 9, 9, 9,
    null, 9, 9, 9, 9, 9, 9,null,
    null, 9,null,null,null,null, 9,null,
    null,null,null,null,null,null,null,null,
  ],
  // Bat (cave level 2) — purple
  bat_0: [
    14,14,null,25,25,null,14,14,
    14,null,25,25,25,25,null,14,
    null,25,25,14,14,25,25,null,
    25,25,14, 7,14, 7,14,25,
    25,25,25,25,25,25,25,25,
    null,25,25,25,25,25,null,null,
    null,null,25,null,null,25,null,null,
    null,null,null,null,null,null,null,null,
  ],
  bat_1: [
    null,null,14,25,25,14,null,null,
    null,14,25,25,25,25,14,null,
    14,25,25,14,14,25,25,14,
    25,25,14, 7,14, 7,14,25,
    null,25,25,25,25,25,null,null,
    null,null,25,25,25,null,null,null,
    null,null,null,25,null,null,null,null,
    null,null,null,null,null,null,null,null,
  ],
  // Skeleton (cave level 3) — bone white
  skel_0: [
    null,null,20,20,20,20,null,null,
    null,20, 1,20,20, 1,20,null,
    null,20,20,20,20,20,20,null,
    null,22,20,22,22,20,22,null,
      22,null,null,22,22,null,null,22,
    null,22,22,22,22,22,22,null,
    null,22,null,22,22,null,22,null,
    null,null,null,null,null,null,null,null,
  ],
  skel_1: [
    null,null,20,20,20,20,null,null,
    null,20, 1,20,20, 1,20,null,
    null,20,20,20,20,20,20,null,
    null,22,20,22,22,20,22,null,
    null,null,22,22,22,22,null,null,
      22,22,null,22,22,null,22,22,
      22,null,null,22,22,null,null,22,
    null,null,null,null,null,null,null,null,
  ],
  boss_p1_1: [
    null, 4,  4,  4,  4,  4,  4,null,
       4, 4,  7,  4,  4,  7,  4,  4,
       4, 4,  4,  4,  4,  4,  4,  4,
    null,20, 20, 20, 20, 20, 20,null,
    null, 4, 20,  4,  4, 20,  4,null,
    null, 4,  4,  4,  4,  4,  4,null,
    null,20,  4,null,null,  4,20,null,
       4,null,null,null,null,null,null,  4,
  ],
  // Phase 2 — ranged mage (purple robe, magenta eyes, ice-blue trim)
  boss_p2_0: [
    null,25, 25, 25, 25, 25, 25,null,
      25,25, 19, 25, 25, 19, 25, 25,
      25,25, 25, 25, 25, 25, 25, 25,
    null,19, 25, 19, 19, 25, 19,null,
      19,25, 18, 25, 25, 18, 25, 19,
    null,25, 25, 25, 25, 25, 25,null,
    null,25,null,null,null,null,25,null,
    null,18,null,null,null,null,18,null,
  ],
  boss_p2_1: [
    null,25, 25, 25, 25, 25, 25,null,
      25,25, 19, 25, 25, 19, 25, 25,
      25,19, 25, 25, 25, 25, 19, 25,
    null,25, 19, 25, 25, 19, 25,null,
    null,19, 25, 18, 18, 25, 19,null,
    null,25, 25, 25, 25, 25, 25,null,
    null,18, 25,null,null,25, 18,null,
    null,null,18,null,null,18,null,null,
  ],
  // Phase 3 — void shadow (near-black, pale eyes, shimmering edges)
  boss_p3_0: [
    null,14, 14, 14, 14, 14, 14,null,
      14,14, 20, 14, 14, 20, 14, 14,
      14,14, 14, 14, 14, 14, 14, 14,
    null,30, 14, 30, 30, 14, 30,null,
      30,14, 20, 14, 14, 20, 14, 30,
    null,14, 30, 14, 14, 30, 14,null,
      20,null,14,null,null,14,null, 20,
    null,null,null,null,null,null,null,null,
  ],
  boss_p3_1: [
    null,14, 14, 14, 14, 14, 14,null,
      14,14, 20, 14, 14, 20, 14, 14,
      14,30, 14, 14, 14, 14, 30, 14,
    null,14, 30, 14, 14, 30, 14,null,
    null,30, 14, 20, 20, 14, 30,null,
    null,14, 14, 14, 14, 14, 14,null,
    null,20, 14,null,null,14, 20,null,
    null,null,20,null,null,20,null,null,
  ],
  // Fireball projectile (phase 2)
  fireball: [
    null,null,null,null,null,null,null,null,
    null,null, 7,  7,null,null,null,null,
    null, 7, 27,  4, 27,  7,null,null,
    null, 7,  4,  7,  4,  7,null,null,
    null, 7, 27,  4, 27,  7,null,null,
    null,null, 7,  7,null,null,null,null,
    null,null,null,null,null,null,null,null,
    null,null,null,null,null,null,null,null,
  ],  
};

buildSpriteCache(SPRITES);

// ================================================================
// TILE ANIMATIONS
// ================================================================
registerTileAnims({
  water: { frames: ['water0','water1'], fps: 2 },
});

// ================================================================
// SOUND
// ================================================================
sound.registerTracks({
  overworld: {
    bpm: 140, loop: true,
    channels: [
      { instrument: 'square',
        notes: 'E5:0.5 G5:0.5 A5:1 E5:0.5 G5:0.5 B5:1 A5:0.5 G5:0.5 A5:0.5 E5:0.5 D5:2 R:1 C5:0.5 E5:0.5 G5:0.5 A5:1 F5:0.5 E5:0.5 D5:0.5 C5:0.5 E5:2 R:1' },
      { instrument: 'triangle',
        notes: 'A3:2 A3:2 F3:2 G3:2 A3:2 A3:2 G3:2 E3:2 C3:2 E3:2 F3:2 G3:2 A3:4' },
    ],
  },
  cave: {
    bpm: 70, loop: true,
    channels: [
      { instrument: 'sine',
        notes: 'A3:2 R:1 G3:1 F3:2 R:1 E3:1 D3:2 R:2 A2:4 R:2 E3:2 R:2 F3:2 R:2' },
      { instrument: 'triangle',
        notes: 'A2:4 R:4 F2:4 R:4 G2:4 R:4 A2:8 R:4' },
    ],
  },
  cave_deep: {
    bpm: 55, loop: true,
    channels: [
      { instrument: 'sine',
        notes: 'D3:3 R:1 C3:2 R:2 A2:4 R:2 D2:6 R:2 E2:3 R:1 F2:2 R:2 D2:8 R:4' },
      { instrument: 'triangle',
        notes: 'D2:6 R:2 C2:6 R:2 A1:8 R:8' },
    ],
  },
});

sound.registerSFX({
  confirm:     { bpm:960, channels:[{ instrument:'square',   notes:'C5:0.1 E5:0.1 G5:0.2' }] },
  dialog:      { bpm:960, channels:[{ instrument:'square',   notes:'C6:0.05' }] },
  portal:      { bpm:480, channels:[{ instrument:'sine',     notes:'A4:0.1 C#5:0.1 E5:0.1 A5:0.2 R:0.1 A6:0.3' }] },
  save:        { bpm:960, channels:[{ instrument:'square',   notes:'G5:0.08 B5:0.08 D6:0.08 G6:0.15' }] },
  cancel:      { bpm:960, channels:[{ instrument:'triangle', notes:'E5:0.1 C5:0.1' }] },
  coin:        { bpm:960, channels:[{ instrument:'square',   notes:'A5:0.06 C6:0.08 E6:0.12' }] },
  hurt:        { bpm:480, channels:[{ instrument:'square',   notes:'A4:0.06 G4:0.1' }] },
  heal:        { bpm:960, channels:[{ instrument:'triangle', notes:'E5:0.08 G5:0.08 C6:0.15' }] },
  chest_open:  { bpm:480, channels:[{ instrument:'square',   notes:'C5:0.08 E5:0.08 G5:0.08 C6:0.2' },
                                     { instrument:'triangle', notes:'C3:0.44' }] },
  bomb:        { bpm:240, channels:[{ instrument:'square',   notes:'G3:0.1 F3:0.1 E3:0.1 D3:0.15' },
                                     { instrument:'triangle', notes:'C2:0.45' }] },
  potion:      { bpm:960, channels:[{ instrument:'sine',     notes:'E5:0.08 G5:0.08 B5:0.08 E6:0.15' }] },
  sword_swing: { bpm:480, channels:[{ instrument:'square',   notes:'G5:0.05 C6:0.07' }] },
  bow_fire:    { bpm:480, channels:[{ instrument:'triangle', notes:'E6:0.04 A5:0.06' }] },
  axe_swing:   { bpm:240, channels:[{ instrument:'square',   notes:'D4:0.1 A3:0.12' }] },
  enemy_die:   { bpm:480, channels:[{ instrument:'square',   notes:'C5:0.05 A4:0.05 F4:0.08' }] },
  weapon_get:  { bpm:480, channels:[{ instrument:'square',   notes:'C5:0.08 E5:0.08 G5:0.08 C6:0.2' },
                                     { instrument:'triangle', notes:'G3:0.44' }] },
  stairs:      { bpm:480, channels:[{ instrument:'sine',     notes:'C4:0.1 E4:0.1 G4:0.15' }] },
});

// ================================================================
// ANIMATION CLIPS
// ================================================================
const CLIPS_PLAYER = {
  idle:      { frames: ['player_idle'],           durations: 0.2  },
  walk_down: { frames: ['player_d0','player_d1'], durations: 0.18 },
  walk_up:   { frames: ['player_u0','player_u1'], durations: 0.18 },
  walk_side: { frames: ['player_s0','player_s1'], durations: 0.18 },
};

setNpcClipFactory(sprite => ({
  idle:      { frames: [sprite], durations: 0.4 },
  walk_down: { frames: [sprite], durations: 0.3 },
  walk_up:   { frames: [sprite], durations: 0.3 },
  walk_side: { frames: [sprite], durations: 0.3 },
}));

// ================================================================
// COLLECTIBLE SYSTEM
// ================================================================
const _pickupFlags = new Map();

function spawnPickupFlagged(wx, wy, type, flagName) {
  if (getFlag(flagName)) return;
  const id = world.createEntity({
    transform: { x: wx, y: wy },
    sprite:    { name: type + '_item', flipX: false },
    pickup:    { type, collected: false },
  });
  _pickupFlags.set(id, flagName);
  return id;
}

function sysPickups() {
  const ptf = world.get(getPlayerId(), 'transform');
  if (!ptf) return;
  for (const id of world.query('pickup', 'transform')) {
    const p  = world.get(id, 'pickup');
    if (p.collected) continue;
    const tf = world.get(id, 'transform');
    const dx = ptf.x - tf.x, dy = ptf.y - tf.y;
    if (Math.abs(dx) < 7 && Math.abs(dy) < 7) {
      p.collected = true;
      switch (p.type) {
        case 'coin':
          hud.addCoins(1);
          sound.playSFX('coin');
          emitBurst(tf.x + 4, tf.y + 4, 'coin');
          break;
        case 'heart':
          hud.addHp(2);
          sound.playSFX('heal');
          emitBurst(tf.x + 4, tf.y + 4, 'sparkle');
          break;
        case 'key':
          setFlag('hasKey');
          hud.setItem(0, 'key_item');
          hud.selectedSlot = 0;
          sound.playSFX('confirm');
          emitBurst(tf.x + 4, tf.y + 4, 'levelup');
          showNote('KEY OBTAINED!');
          break;
        default:
          showNote(p.type.toUpperCase() + ' [E/Q to cycle items]');
          break;
      }
      world.destroyEntity(id);
    }
  }
}

function sysPickupFlags() {
  for (const [id, flagName] of [..._pickupFlags]) {
    if (!world.has(id, 'pickup')) {
      setFlag(flagName);
      _pickupFlags.delete(id);
    }
  }
}

// ================================================================
// COMBAT / WEAPON SYSTEM
// ================================================================
const ZELDA_WEAPONS = {
  sword_basic: {
    name: 'SWORD', type: 'melee',
    damage: 1, cooldownMax: 0.4,
    swingW: 14, swingH: 14, swingLife: 0.15,
    swingSprite: 'sword_swing', knockback: 55,
    sfx: 'sword_swing', team: 'player',
  },
  sword_item: {
    name: 'IRON SWORD', type: 'melee',
    damage: 2, cooldownMax: 0.35,
    swingW: 16, swingH: 16, swingLife: 0.18,
    swingSprite: 'sword_swing', knockback: 75,
    sfx: 'sword_swing', team: 'player',
  },
  bow_item: {
    name: 'BOW', type: 'ranged',
    damage: 1, cooldownMax: 0.65,
    projSprite: 'arrow_proj', projSpeed: 135, projLife: 1.5,
    piercing: false, knockback: 20,
    sfx: 'bow_fire', team: 'player',
  },
  axe_item: {
    name: 'WAR AXE', type: 'melee',
    damage: 3, cooldownMax: 0.85,
    swingW: 18, swingH: 18, swingLife: 0.22,
    swingSprite: 'sword_swing', knockback: 110,
    sfx: 'axe_swing', team: 'player',
  },
  shield_item: null, // passive — handled in damageable onHit
};

// Player facing direction, updated in sysInput override
let playerFacing = { dx: 1, dy: 0 };
let attackCooldown = 0;

function sysPlayerAttack(delta) {
  if (dialog.active || cutscene.isInputLocked() || sceneTransition.state !== 'none') return;
  if (attackCooldown > 0) { attackCooldown = Math.max(0, attackCooldown - delta); return; }
  if (!input.pressed('attack')) return;

  const ptf = world.get(getPlayerId(), 'transform');
  if (!ptf) return;

  // Resolve active weapon: selected item slot or default sword
  const selectedItem = hud.selectedSlot !== null ? hud.items[hud.selectedSlot] : null;
  let weaponKey = 'sword_basic';
  if (selectedItem === 'sword_item') weaponKey = 'sword_item';
  else if (selectedItem === 'bow_item')   weaponKey = 'bow_item';
  else if (selectedItem === 'axe_item')   weaponKey = 'axe_item';
  else if (selectedItem === 'shield_item') {
    showNote('SHIELD IS PASSIVE — EQUIP A WEAPON');
    return;
  }

  const weapon = ZELDA_WEAPONS[weaponKey];
  if (!weapon) return;

  spawnAttack(getPlayerId(), weapon, ptf.x, ptf.y, playerFacing.dx, playerFacing.dy);
  attackCooldown = weapon.cooldownMax;
  sound.playSFX(weapon.sfx);
  showNote(weapon.name + '!', 0.6);
}

// ================================================================
// ENEMY SYSTEM
// ================================================================
const ENEMY_DEFS = {
  slime: {
    frames: ['slime_0','slime_1'],
    speed: 28, aggroRange: 64,
    hp: 2, maxHp: 2,
    damage: 1, knockback: 30,
    drop: 'coin',
  },
  bat: {
    frames: ['bat_0','bat_1'],
    speed: 52, aggroRange: 88,
    hp: 3, maxHp: 3,
    damage: 1, knockback: 40,
    drop: 'coin',
  },
  skeleton: {
    frames: ['skel_0','skel_1'],
    speed: 22, aggroRange: 72,
    hp: 5, maxHp: 5,
    damage: 2, knockback: 55,
    drop: 'heart',
  },
};

function spawnEnemy(type, tileX, tileY, opts = {}) {
  const def = ENEMY_DEFS[type];
  if (!def) return;
  world.createEntity({
    transform: { x: tileX * TILE_SIZE, y: tileY * TILE_SIZE },
    sprite:    { name: def.frames[0], flipX: false },
    velocity:  { dx: 0, dy: 0, speed: def.speed },
    collider:  true,
    enemy: {
      type,
      speed:       def.speed,
      aggroRange:  def.aggroRange,
      frames:      def.frames,
      frameIdx:    0,
      animTimer:   0,
      wanderTimer: Math.random() * 2,
      wanderDx:    Math.cos(Math.random() * Math.PI * 2),
      wanderDy:    Math.sin(Math.random() * Math.PI * 2),
      drop:        def.drop,
      aggroGroup:  opts.aggroGroup ?? null,
    },
    damageable: {
      hp: def.hp, maxHp: def.maxHp,
      iframes: 0, iframeMax: 0.45,
      team: 'enemy',
      onHit(vid) {
        const tf = world.get(vid, 'transform');
        if (tf) emitBurst(tf.x + 4, tf.y + 4, 'hit');
      },
      onDeath(vid) {
        const e  = world.get(vid, 'enemy');
        const tf = world.get(vid, 'transform');
        if (tf && e) {
          emitBurst(tf.x + 4, tf.y + 4, 'levelup');
          // Drop item — no flag (enemy drops are ephemeral)
          world.createEntity({
            transform: { x: tf.x, y: tf.y },
            sprite:    { name: e.drop + '_item', flipX: false },
            pickup:    { type: e.drop, collected: false },
          });
        }
        sound.playSFX('enemy_die');
        world.destroyEntity(vid);
      },
    },
    damager: { damage: def.damage, team: 'enemy', knockback: def.knockback },
  });
}

function sysEnemyAI(delta) {
  const ptf = world.get(getPlayerId(), 'transform');
  if (!ptf) return;

  // Pass 1 — collect which aggro groups have at least one member in range.
  const _alertedGroups = new Set();
  for (const id of world.query('enemy', 'transform')) {
    const tf = world.get(id, 'transform');
    const e  = world.get(id, 'enemy');
    if (!tf || !e || !e.aggroGroup) continue;
    const dx = ptf.x - tf.x, dy = ptf.y - tf.y;
    if (Math.sqrt(dx*dx + dy*dy) < e.aggroRange) _alertedGroups.add(e.aggroGroup);
  }

  for (const id of world.query('enemy', 'transform', 'velocity')) {
    const tf  = world.get(id, 'transform');
    const vel = world.get(id, 'velocity');
    const e   = world.get(id, 'enemy');
    const sp  = world.get(id, 'sprite');
    const dmg = world.get(id, 'damageable');
    if (!tf || !vel || !e) continue;

    // Freeze during knockback iframe period
    if (dmg && dmg.iframes > dmg.iframeMax * 0.6) {
      vel.dx *= 0.85; vel.dy *= 0.85;
      continue;
    }

    const dx   = ptf.x - tf.x;
    const dy   = ptf.y - tf.y;
    const dist = Math.sqrt(dx * dx + dy * dy);

    const inRange   = dist < e.aggroRange;
    const groupAlert = e.aggroGroup && _alertedGroups.has(e.aggroGroup);

    if ((inRange || groupAlert) && dist > 2) {
      // Chase player
      vel.dx = (dx / dist) * e.speed;
      vel.dy = (dy / dist) * e.speed;
      e.wanderTimer = 0;
    } else {
      // Wander
      e.wanderTimer -= delta;
      if (e.wanderTimer <= 0) {
        e.wanderTimer = 1.2 + Math.random() * 2.0;
        const angle = Math.random() * Math.PI * 2;
        e.wanderDx = Math.cos(angle);
        e.wanderDy = Math.sin(angle);
      }
      vel.dx = e.wanderDx * e.speed * 0.45;
      vel.dy = e.wanderDy * e.speed * 0.45;
    }

    // Animate
    if (sp) {
      e.animTimer += delta;
      if (e.animTimer >= 0.28) {
        e.animTimer -= 0.28;
        e.frameIdx = (e.frameIdx + 1) % e.frames.length;
        sp.name = e.frames[e.frameIdx];
      }
      if (Math.abs(vel.dx) > 1) sp.flipX = vel.dx < 0;
    }
  }
}

// ================================================================
// FOOTSTEP PARTICLES
// ================================================================
let _footTimer = 0;
function sysFootsteps(delta) {
  const vel = world.get(getPlayerId(), 'velocity');
  const tf  = world.get(getPlayerId(), 'transform');
  if (!vel || !tf) return;
  if (vel.dx === 0 && vel.dy === 0) { _footTimer = 0; return; }
  _footTimer += delta;
  if (_footTimer >= 0.18) {
    _footTimer = 0;
    emitBurst(tf.x + 4, tf.y + 7, 'footstep');
  }
}

// ================================================================
// PORTAL SPARKLES
// ================================================================
let _portalTimer = 0;
function sysPortalSparkles(delta) {
  _portalTimer += delta;
  if (_portalTimer < 0.12) return;
  _portalTimer = 0;
  const portals = getScenes()[worldState.currentScene]?.portals ?? [];
  for (const p of portals) {
    emitBurst(p.tileX * TILE_SIZE + 4, p.tileY * TILE_SIZE + 4, 'sparkle');
  }
}

// ================================================================
// ITEM USE HANDLERS
// ================================================================
function registerAllItemUseHandlers() {
  hud.registerItemUse('key_item', () => {
    showNote('USE THE KEY NEAR A LOCKED DOOR');
    return false;
  });
  hud.registerItemUse('bomb_item', (slot) => {
    const ptf = world.get(getPlayerId(), 'transform');
    if (!ptf) return;
    sound.playSFX('bomb');
    emitBurst(ptf.x + 4, ptf.y + 4, 'hit');
    emitBurst(ptf.x + 4, ptf.y + 4, 'smoke');
    showNote('BOOM!');
    hud.clearItem(slot);
    hud.selectedSlot = null;
    return false;
  });
  hud.registerItemUse('potion_item', (slot) => {
    if (hud.hp >= hud.maxHp) { showNote('ALREADY AT FULL HP'); return false; }
    hud.addHp(4);
    sound.playSFX('potion');
    const ptf = world.get(getPlayerId(), 'transform');
    if (ptf) emitBurst(ptf.x + 4, ptf.y + 4, 'sparkle');
    showNote('+4 HP!');
    hud.clearItem(slot);
    hud.selectedSlot = null;
    return false;
  });
  hud.registerItemUse('sword_item', () => {
    showNote('IRON SWORD — PRESS X TO ATTACK');
    return false;
  });
  hud.registerItemUse('bow_item', () => {
    showNote('BOW — PRESS X TO FIRE');
    return false;
  });
  hud.registerItemUse('axe_item', () => {
    showNote('WAR AXE — PRESS X TO SWING');
    return false;
  });
  hud.registerItemUse('shield_item', () => {
    showNote('SHIELD IS PASSIVE — REDUCES DAMAGE');
    return false;
  });
}

// ================================================================
// NPC DIALOG BRANCHES
// ================================================================
const VILLAGER_BRANCHES = [
  {
    requires: ['foundCrystal'],
    lines: [
      'YOU FOUND THE CRYSTAL!\nTHIS CALLS FOR A\nCELEBRATION!',
      'TAKE THIS AS THANKS\nFOR YOUR BRAVERY.',
    ],
    setFlags:   ['rewarded'],
    clearFlags: ['foundCrystal'],
    addCoins:   5,
    emit:       { x: 12*8+4, y: 12*8+4, preset: 'levelup' },
  },
  {
    requires: ['enteredCave', 'hasKey'],
    excludes: ['foundCrystal'],
    lines: [
      'A KEY FROM THE CAVE!\nYOU ARE BRAVER THAN\nI THOUGHT.',
      'THE CRYSTAL CHAMBER\nLIES DEEP WITHIN.\nGOOD LUCK!',
    ],
  },
  {
    requires: ['enteredCave'],
    excludes: ['hasKey', 'foundCrystal'],
    lines: [
      'SO YOU ENTERED THE\nCRYSTAL CAVE.',
      'DID YOU FIND ANYTHING\nINSIDE? I HEAR THERE\nIS A HIDDEN KEY...',
    ],
  },
  {
    excludes: ['metVillager'],
    lines: [
      'GREETINGS, TRAVELER!\nWELCOME TO OUR VILLAGE.',
      'THE CRYSTAL CAVE LIES\nTO THE EAST. A GLOWING\nPORTAL MARKS THE WAY.',
      'FEW WHO ENTER RETURN\nTO TELL THE TALE.\nTAKE THIS FOR LUCK.',
    ],
    setFlags: ['metVillager'],
    addCoins: 3,
    runScript: [{ cmd:'sfx', name:'coin' }],
  },
  {
    lines: ['BE CAREFUL OUT THERE.\nAND KEEP AN EYE ON\nTHAT CAVE PORTAL.'],
  },
];

// ================================================================
// CAVE ENTRY CUTSCENE
// ================================================================
function buildCaveEntryCutscene(sageId) {
  return [
    { cmd:'lockInput', value: true },
    { cmd:'wait', seconds: 0.4 },
    { cmd:'move', id: sageId, tx: 5, ty: 8, speed: 35 },
    { cmd:'sfx',  name: 'portal' },
    { cmd:'dialog', name: 'CAVE SAGE',
      lines: [
        'WAIT! STOP RIGHT THERE.',
        'YOU ARE THE FIRST TO\nENTER IN MANY YEARS.',
        'TAKE THIS HEART. YOU\nWILL NEED IT AHEAD.',
        'BEWARE: SLIMES LURK\nIN THE DARK. PRESS X\nTO SWING YOUR SWORD.',
        'STAIRS LEAD DEEPER.\nEACH LEVEL IS MORE\nDANGEROUS THAN THE LAST.',
      ],
    },
    { cmd:'flag',  name: 'enteredCave' },
    { cmd:'call',  fn: () => { hud.addHp(2); sound.playSFX('heal'); emitBurst(4*8+4, 8*8+4, 'sparkle'); } },
    { cmd:'lockInput', value: false },
  ];
}

// ================================================================
// MAP BUILDERS
// ================================================================
function buildOverworld(cols, rows) {
  const bg  = Array.from({length: rows}, () => Array(cols).fill('grass'));
  const obj = Array.from({length: rows}, () => Array(cols).fill(null));
  const col = Array.from({length: rows}, () => Array(cols).fill(false));

  // Water lake
  for (let r = 4; r <= 6; r++)
    for (let c = 5; c <= 9; c++) { bg[r][c] = 'water'; col[r][c] = true; }
  // Stone ruins
  for (let r = 9; r <= 11; r++)
    for (let c = 6; c <= 10; c++) bg[r][c] = 'stone';
  // Walled village
  for (let r = 20; r <= 25; r++)
    for (let c = 15; c <= 22; c++)
      if (r === 20 || r === 25 || c === 15 || c === 22)
        { obj[r][c] = 'wall'; col[r][c] = true; }
  // Trees
  [[1,1],[1,4],[2,8],[3,18],[6,14],[0,12],[9,25],[11,28],[16,5],[13,8],[22,2],[24,6],
   [5,32],[12,38],[20,30],[28,5],[30,12],[32,20],[25,35]].forEach(([r,c]) => {
    if (r < rows && c < cols) { obj[r][c] = 'tree'; col[r][c] = true; }
  });
  // Flowers
  [[3,3],[4,12],[7,3],[8,18],[13,7],[19,12],[22,28],[28,15]].forEach(([r,c]) => {
    if (r < rows && c < cols) obj[r][c] = 'flower';
  });

  obj[8][35] = 'portal';
  return { bg, objects: obj, collision: col };
}

function buildCaveL1(cols, rows) {
  const bg  = Array.from({length: rows}, (_, r) =>
    Array.from({length: cols}, (_, c) =>
      (r === 0 || r === rows-1 || c === 0 || c === cols-1) ? 'cave_wall' : 'cave_floor'));
  const obj = Array.from({length: rows}, () => Array(cols).fill(null));
  const col = Array.from({length: rows}, (_, r) =>
    Array.from({length: cols}, (_, c) =>
      r === 0 || r === rows-1 || c === 0 || c === cols-1));

  // Inner room walls
  for (let r = 4; r <= 12; r++)
    for (let c = 5; c <= 14; c++)
      if ((r === 4 || r === 12 || c === 5 || c === 14) &&
          !(r === 8 && (c === 5 || c === 14)))
        { bg[r][c] = 'cave_wall'; col[r][c] = true; }

  // Crystals
  [[2,5],[2,10],[2,16],[16,3],[16,10],[16,16],[6,8],[9,11],[7,2],[14,17]].forEach(([r,c]) => {
    if (r < rows && c < cols && !col[r][c]) obj[r][c] = 'crystal';
  });

  // Staircase down to B2
  obj[15][17] = 'stairs_down';

  // Portal back to overworld
  obj[8][1]  = 'portal'; col[8][1] = false;
  bg[8][0]   = 'cave_floor'; col[8][0] = false;
  return { bg, objects: obj, collision: col };
}

function buildCaveL2(cols, rows) {
  const bg  = Array.from({length: rows}, (_, r) =>
    Array.from({length: cols}, (_, c) =>
      (r === 0 || r === rows-1 || c === 0 || c === cols-1) ? 'cave_wall' : 'cave_floor_b2'));
  const obj = Array.from({length: rows}, () => Array(cols).fill(null));
  const col = Array.from({length: rows}, (_, r) =>
    Array.from({length: cols}, (_, c) =>
      r === 0 || r === rows-1 || c === 0 || c === cols-1));

  // Pillar columns
  [[3,4],[3,10],[3,16],[8,7],[8,13],[14,4],[14,10],[14,16]].forEach(([r,c]) => {
    if (r < rows && c < cols) { bg[r][c] = 'cave_wall'; col[r][c] = true; }
  });
  // Corridor walls splitting the room
  for (let c = 4; c <= 16; c++)
    if (c !== 7 && c !== 13)
      { bg[6][c] = 'cave_wall'; col[6][c] = true; }
  for (let c = 4; c <= 16; c++)
    if (c !== 7 && c !== 13)
      { bg[11][c] = 'cave_wall'; col[11][c] = true; }

  // Crystals decorating walls
  [[2,2],[2,8],[2,14],[16,2],[16,8],[16,14],[5,2],[5,17],[9,2],[9,17]].forEach(([r,c]) => {
    if (r < rows && c < cols && !col[r][c]) obj[r][c] = 'crystal';
  });

  // Stairs up (to cave L1) and down (to cave L3)
  obj[15][2] = 'stairs_up';
  obj[2][17] = 'stairs_down';

  return { bg, objects: obj, collision: col };
}

function buildCaveL3(cols, rows) {
  const bg  = Array.from({length: rows}, (_, r) =>
    Array.from({length: cols}, (_, c) =>
      (r === 0 || r === rows-1 || c === 0 || c === cols-1) ? 'cave_wall' : 'cave_floor_b3'));
  const obj = Array.from({length: rows}, () => Array(cols).fill(null));
  const col = Array.from({length: rows}, (_, r) =>
    Array.from({length: cols}, (_, c) =>
      r === 0 || r === rows-1 || c === 0 || c === cols-1));

  // Boss chamber walls — cross pattern
  for (let r = 5; r <= 12; r++) {
    bg[r][5]  = 'cave_wall'; col[r][5]  = true;
    bg[r][14] = 'cave_wall'; col[r][14] = true;
  }
  for (let c = 5; c <= 14; c++) {
    bg[5][c]  = 'cave_wall'; col[5][c]  = true;
    bg[12][c] = 'cave_wall'; col[12][c] = true;
  }
  // Chamber door openings
  col[8][5]  = false; bg[8][5]  = 'cave_floor_b3';
  col[8][14] = false; bg[8][14] = 'cave_floor_b3';
  col[5][9]  = false; bg[5][9]  = 'cave_floor_b3';
  col[12][9] = false; bg[12][9] = 'cave_floor_b3';

  // Crystals
  [[2,2],[2,8],[2,17],[16,2],[16,8],[16,17],[3,12],[15,12]].forEach(([r,c]) => {
    if (r < rows && c < cols && !col[r][c]) obj[r][c] = 'crystal';
  });

  // Stairs up to cave B2
  obj[15][17] = 'stairs_up';
  obj[2][2]   = 'stairs_down';

  return { bg, objects: obj, collision: col };
}

function buildCaveL4(cols, rows) {
  const bg  = Array.from({length: rows}, (_, r) =>
    Array.from({length: cols}, (_, c) =>
      (r === 0 || r === rows-1 || c === 0 || c === cols-1) ? 'cave_wall' : 'cave_floor_b3'));
  const obj = Array.from({length: rows}, () => Array(cols).fill(null));
  const col = Array.from({length: rows}, (_, r) =>
    Array.from({length: cols}, (_, c) =>
      r === 0 || r === rows-1 || c === 0 || c === cols-1));

  // Boss arena — central sealed chamber with four doorways
  for (let r = 4; r <= 13; r++) {
    bg[r][4]  = 'cave_wall'; col[r][4]  = true;
    bg[r][15] = 'cave_wall'; col[r][15] = true;
  }
  for (let c = 4; c <= 15; c++) {
    bg[4][c]  = 'cave_wall'; col[4][c]  = true;
    bg[13][c] = 'cave_wall'; col[13][c] = true;
  }
  // Doorways — north/south/west/east openings (one tile wide)
  col[4][9]  = false; bg[4][9]  = 'cave_floor_b3';
  col[13][9] = false; bg[13][9] = 'cave_floor_b3';
  col[8][4]  = false; bg[8][4]  = 'cave_floor_b3';
  col[8][15] = false; bg[8][15] = 'cave_floor_b3';

  // Crystal pillars decorating the antechamber
  [[2,3],[2,9],[2,16],[15,3],[15,9],[15,16],[6,1],[6,18],[11,1],[11,18]].forEach(([r,c]) => {
    if (r > 0 && r < rows-1 && c > 0 && c < cols-1 && !col[r][c]) obj[r][c] = 'crystal';
  });

  // Boss throne marker (crystal at boss spawn point)
  obj[8][9] = 'crystal';

  // Stairs up to B3 (south-west antechamber)
  obj[15][3] = 'stairs_up';

  // Locked exit portal (north-east antechamber — guarded until boss dies)
  obj[2][16] = 'portal';

  return { bg, objects: obj, collision: col };
}

// ================================================================
// SCENE DIMENSIONS
// ================================================================
const OW_COLS   = 40, OW_ROWS   = 36;
const CAVE_COLS = 20, CAVE_ROWS = 18;

const { bg: owBg,  objects: owObj,  collision: owCol  } = buildOverworld(OW_COLS, OW_ROWS);
const { bg: c1Bg,  objects: c1Obj,  collision: c1Col  } = buildCaveL1(CAVE_COLS, CAVE_ROWS);
const { bg: c2Bg,  objects: c2Obj,  collision: c2Col  } = buildCaveL2(CAVE_COLS, CAVE_ROWS);
const { bg: c3Bg,  objects: c3Obj,  collision: c3Col  } = buildCaveL3(CAVE_COLS, CAVE_ROWS);
const { bg: c4Bg,  objects: c4Obj,  collision: c4Col  } = buildCaveL4(CAVE_COLS, CAVE_ROWS);

// ================================================================
// BOSS — THE VOID HERALD (cave_b4)
// Three-phase fight. Uses engine's spawnEnemy (enemyAI component)
// so sysEnemy + sysSpawner must run in the game loop (added above).
// ================================================================
let _bossId    = -1;
let _bossPhase =  0;   // 0 = not yet spawned, 1/2/3 = active phase
let _b4SpawnersAlive = [];   // track phase-3 minion spawners

function _bossClips(phase) {
  const f0 = `boss_p${phase}_0`, f1 = `boss_p${phase}_1`;
  return {
    idle:      { frames: [f0, f1], durations: 0.5  },
    walk_down: { frames: [f0, f1], durations: 0.2  },
    walk_up:   { frames: [f0, f1], durations: 0.2  },
    walk_side: { frames: [f0, f1], durations: 0.2  },
    attack:    { frames: [f1, f0], durations: 0.12 },
  };
}

function _bossEnterPhase2(vid) {
  const ai  = world.get(vid, 'enemyAI');
  const dmg = world.get(vid, 'damageable');
  const anim = world.get(vid, 'animator');
  if (!ai || !dmg) return;

  // Swap to ranged configuration
  ai.weapon = {
    type:        'ranged',
    projSprite:  'fireball',
    projSpeed:   70,
    projLife:    2.0,
    damage:      2,
    cooldownMax: 1.6,
    knockback:   25,
    team:        'boss',
  };
  ai.kiteRange   = 36;
  ai.attackRange = 64;
  ai.speed       = 18;
  if (anim) { Object.assign(anim, _bossClips(2)); animatorPlay(anim, 'idle'); }
  dmg.iframeMax  = 0.5;

  const tf = world.get(vid, 'transform');
  if (tf) emitBurst(tf.x + 4, tf.y + 4, 'levelup');
  sound.playSFX('alert');

  cutscene.run([
    { cmd: 'lockInput', value: true },
    { cmd: 'sfx',   name: 'alert' },
    { cmd: 'dialog', name: 'VOID HERALD',
      lines: ['FLESH MEANS NOTHING!', 'FEEL THE ARCANE STORM!'] },
    { cmd: 'lockInput', value: false },
  ]);
}

function _bossEnterPhase3(vid) {
  const ai  = world.get(vid, 'enemyAI');
  const dmg = world.get(vid, 'damageable');
  const anim = world.get(vid, 'animator');
  if (!ai || !dmg) return;

  // Back to slow melee but spawns minions continuously
  ai.weapon = {
    type:        'melee',
    damage:      3,
    cooldownMax: 0.9,
    knockback:   60,
    swingW: 14, swingH: 12, swingLife: 0.14,
    team: 'boss',
  };
  ai.kiteRange   = 0;
  ai.attackRange = 14;
  ai.speed       = 20;
  if (anim) { Object.assign(anim, _bossClips(3)); animatorPlay(anim, 'idle'); }
  dmg.iframeMax = 0.35;

  const tf = world.get(vid, 'transform');
  if (tf) emitBurst(tf.x + 4, tf.y + 4, 'hit');
  sound.playSFX('alert');

  cutscene.run([
    { cmd: 'lockInput', value: true },
    { cmd: 'sfx',   name: 'alert' },
    { cmd: 'dialog', name: 'VOID HERALD',
      lines: ['I AM THE DARKNESS ITSELF!', 'MY CHILDREN WILL DEVOUR YOU!'] },
    { cmd: 'lockInput', value: false },
  ]);

  // Spawn three minion spawners in the arena corners (10-s respawn each)
  _b4SpawnersAlive = [];
  const minionPositions = [[6,6],[6,12],[11,6],[11,12]];
  for (const [ty, tx] of minionPositions) {
    const sid = createSpawner({
      tileX: tx, tileY: ty,
      sprite: {
        idle:      { frames: ['skel_0','skel_1'], durations: 0.4 },
        walk_down: { frames: ['skel_0','skel_1'], durations: 0.22 },
        walk_up:   { frames: ['skel_0','skel_1'], durations: 0.22 },
        walk_side: { frames: ['skel_0','skel_1'], durations: 0.22 },
      },
      hp: 3, speed: 30,
      alertRange: 999, attackRange: 14, leashRange: 999,
      useLOS: false,
      aggroGroup: 'b4_minions',
      weapon: { damage: 1, knockback: 30, cooldownMax: 1.0 },
      onDeath(vid2) {
        const t2 = world.get(vid2, 'transform');
        if (t2) emitBurst(t2.x + 4, t2.y + 4, 'hit');
        sound.playSFX('enemy_die');
      },
    }, { respawnDelay: 10 });
    _b4SpawnersAlive.push(sid);
  }
}

function _bossVictory(vid) {
  // Destroy all minion spawners
  for (const sid of _b4SpawnersAlive) {
    if (world.has(sid, 'spawner')) world.destroyEntity(sid);
  }
  _b4SpawnersAlive = [];

  // Destroy all remaining minion enemies
  for (const eid of world.query('enemyAI')) {
    if (eid !== vid) world.destroyEntity(eid);
  }

  const tf = world.get(vid, 'transform');
  const px = tf ? tf.x + 4 : 9 * TILE_SIZE;
  const py = tf ? tf.y + 4 : 8 * TILE_SIZE;

  setFlag('boss_b4_dead');
  _bossPhase = 0;

  cutscene.run([
    { cmd: 'lockInput', value: true },
    { cmd: 'stopBgm' },
    { cmd: 'sfx',   name: 'enemy_die' },
    { cmd: 'emit',  x: px, y: py, preset: 'levelup' },
    { cmd: 'wait',  seconds: 0.4 },
    { cmd: 'emit',  x: px - 8, y: py - 4, preset: 'levelup' },
    { cmd: 'emit',  x: px + 8, y: py - 4, preset: 'levelup' },
    { cmd: 'wait',  seconds: 0.5 },
    { cmd: 'dialog', name: 'VOID HERALD',
      lines: ['...THE VOID... RECLAIMS ME...', 'YOU CANNOT... STOP WHAT COMES...'] },
    { cmd: 'wait',  seconds: 0.3 },
    { cmd: 'emit',  x: px, y: py, preset: 'chest' },
    { cmd: 'bgm',   name: 'overworld' },
    { cmd: 'dialog', name: 'SYSTEM',
      lines: ['THE VOID HERALD IS VANQUISHED!', 'PEACE RETURNS TO THE DEEP.'] },
    { cmd: 'call',  fn() {
        hud.addCoins(20);
        hud.setMaxHp(hud.maxHp + 4);
        hud.addHp(4);
        showNote('BOSS DEFEATED! +20 COINS  +4 MAX HP');
      }},
    { cmd: 'note',  text: 'THE CAVE DOOR IS NOW OPEN.' },
    { cmd: 'lockInput', value: false },
  ]);
}

function spawnBoss() {
  _bossPhase = 1;
  _bossId = Engine.spawnEnemy({
    x: 9 * TILE_SIZE, y: 8 * TILE_SIZE,
    sprite:      _bossClips(1),
    hp:          24, maxHp: 24,
    speed:       26,
    alertRange:  999,
    attackRange: 14,
    leashRange:  999,
    useLOS:      false,
    team:        'boss',
    aggroGroup:  'cave_b4_boss',
    iframeMax:   0.65,
    weapon: {
      type:        'melee',
      damage:      2,
      cooldownMax: 1.1,
      knockback:   50,
      swingW: 12, swingH: 10, swingLife: 0.13,
      team: 'boss',
    },

    onHit(vid, _aid, _amount) {
      const dmg = world.get(vid, 'damageable');
      if (!dmg) return;

      if (_bossPhase === 1 && dmg.hp <= 16) {   // ≤ 66 % → phase 2
        _bossPhase = 2;
        _bossEnterPhase2(vid);
      } else if (_bossPhase === 2 && dmg.hp <= 8) {  // ≤ 33 % → phase 3
        _bossPhase = 3;
        _bossEnterPhase3(vid);
      }
    },

    onDeath(vid) {
      _bossVictory(vid);
    },
  });
}

function _buildBossIntroCutscene() {
  return [
    { cmd: 'lockInput', value: true },
    { cmd: 'bgm',   name: 'cave_deep' },
    { cmd: 'wait',  seconds: 0.5 },
    { cmd: 'dialog', name: 'VOID HERALD',
      lines: [
        'SO... A MORTAL DARES\nENTER MY SANCTUM.',
        'THE DARKNESS YOU SEEK\nIS ME.',
        'TURN BACK AND YOUR DEATH\nWILL BE SWIFT.',
        'STAY... AND SUFFER.',
      ]},
    { cmd: 'wait',  seconds: 0.3 },
    { cmd: 'call',  fn() { spawnBoss(); } },
    { cmd: 'sfx',   name: 'alert' },
    { cmd: 'lockInput', value: false },
  ];
}

// ================================================================
// SCENES
// ================================================================
const SCENE_DATA = {
  overworld: (() => ({
    worldCols: OW_COLS, worldRows: OW_ROWS, bgColor: 0,
    playerStart: { tileX: 15, tileY: 15 },
    music: 'overworld',
    layerBG: owBg, layerObjects: owObj, layerCollision: owCol,
    portals: [
      { tileX: 16, tileY: 15, targetScene: 'cave_b2', targetTileX: 16, targetTileY: 2,
        onActivate() { sound.playSFX('stairs'); showNote('ASCENDING TO B2...'); } },
      { tileX: 2, tileY: 2, targetScene: 'cave_b4', targetTileX: 3, targetTileY: 14,
        onActivate() { sound.playSFX('stairs'); showNote('DESCENDING TO B4...'); } },
    ],
    chests: [
      // Original chests
      {
        tileX: 14, tileY: 20, flagName: 'chest_ow_bomb',
        loot: [{
          sprite: 'bomb_item',
          label: 'BOMB OBTAINED! [E/Q: cycle  Z: use]',
          onPickup() {
            const slot = hud.items.indexOf(null);
            if (slot >= 0) { hud.setItem(slot, 'bomb_item'); hud.selectedSlot = slot; }
          },
        }],
      },
      {
        tileX: 9, tileY: 10, flagName: 'chest_ow_potion',
        loot: [{
          sprite: 'potion_item',
          label: 'POTION OBTAINED! [Z: use to restore HP]',
          onPickup() {
            const slot = hud.items.indexOf(null);
            if (slot >= 0) { hud.setItem(slot, 'potion_item'); hud.selectedSlot = slot; }
          },
        }],
      },
      // === NEW WEAPON CHESTS ===
      // Sword — east plains, near portal
      {
        tileX: 30, tileY: 15, flagName: 'chest_ow_sword',
        loot: [{
          sprite: 'sword_item',
          label: 'IRON SWORD! [Select + X to attack]',
          onPickup() {
            sound.playSFX('weapon_get');
            emitBurst(30*8+4, 15*8+4, 'levelup');
            const slot = hud.items.indexOf(null);
            if (slot >= 0) { hud.setItem(slot, 'sword_item'); hud.selectedSlot = slot; }
            showNote('IRON SWORD — STRONGER ATTACKS!');
          },
        }],
      },
      // Bow — southwest open plains
      {
        tileX: 6, tileY: 28, flagName: 'chest_ow_bow',
        loot: [{
          sprite: 'bow_item',
          label: 'BOW OBTAINED! [Select + X to fire arrow]',
          onPickup() {
            sound.playSFX('weapon_get');
            emitBurst(6*8+4, 28*8+4, 'levelup');
            const slot = hud.items.indexOf(null);
            if (slot >= 0) { hud.setItem(slot, 'bow_item'); hud.selectedSlot = slot; }
            showNote('BOW — RANGED ATTACKS!');
          },
        }],
      },
      // War Axe — far east, near cave
      {
        tileX: 34, tileY: 26, flagName: 'chest_ow_axe',
        loot: [{
          sprite: 'axe_item',
          label: 'WAR AXE OBTAINED! [Heavy melee]',
          onPickup() {
            sound.playSFX('weapon_get');
            emitBurst(34*8+4, 26*8+4, 'levelup');
            const slot = hud.items.indexOf(null);
            if (slot >= 0) { hud.setItem(slot, 'axe_item'); hud.selectedSlot = slot; }
            showNote('WAR AXE — MASSIVE DAMAGE!');
          },
        }],
      },
      // Shield — north of village
      {
        tileX: 18, tileY: 18, flagName: 'chest_ow_shield',
        loot: [{
          sprite: 'shield_item',
          label: 'SHIELD OBTAINED! [Passive: reduces damage]',
          onPickup() {
            sound.playSFX('weapon_get');
            emitBurst(18*8+4, 18*8+4, 'levelup');
            setFlag('hasShield');
            const slot = hud.items.indexOf(null);
            if (slot >= 0) { hud.setItem(slot, 'shield_item'); }
            showNote('SHIELD — PASSIVE DEFENCE +1');
          },
        }],
      },
    ],
    npcs: [
      {
        tileX: 12, tileY: 12, sprite: 'npc_a', name: 'VILLAGER',
        dialog:         ['...'],
        dialogBranches: VILLAGER_BRANCHES,
        patrol: {
          speed: 20, waypointIdx: 0,
          waypoints: [{x:12*8,y:12*8},{x:15*8,y:12*8},{x:15*8,y:15*8},{x:12*8,y:15*8}],
        },
      },
      {
        tileX: 7, tileY: 10, sprite: 'npc_b', name: 'SCHOLAR',
        dialog: ['AH, A NEW FACE!'],
        dialogBranches: [
          {
            requires: ['rewarded'],
            lines: ['LOOKS LIKE THE VILLAGER\nWAS PLEASED WITH YOUR\nADVENTURE. WELL DONE!'],
          },
          {
            requires: ['hasKey'],
            excludes: ['rewarded'],
            lines: ['THAT KEY YOU CARRY...\nIT OPENS THE CRYSTAL\nCHAMBER DEEP INSIDE!'],
          },
          {
            lines: [
              'AH, A NEW FACE!',
              'PRESS Z NEAR A CHEST\nOR NPC TO INTERACT.',
              'PRESS X TO ATTACK\nWITH YOUR SWORD.',
              'WEAPON CHESTS ARE\nHIDDEN ACROSS THE LAND.\nEXPLORE WELL!',
              'E/Q CYCLES ITEMS.\nZ USES THE SELECTED ITEM.',
              'M TOGGLES THE MINIMAP.',
            ],
          },
        ],
      },
    ],
    onEnter() {
      spawnPickupFlagged(10*8,  8*8, 'coin',  'coinOW1');
      spawnPickupFlagged(18*8, 20*8, 'coin',  'coinOW2');
      spawnPickupFlagged(25*8,  6*8, 'heart', 'heartOW');
      // Extra coins scattered around overworld
      spawnPickupFlagged(32*8,  3*8, 'coin',  'coinOW3');
      spawnPickupFlagged( 3*8, 22*8, 'coin',  'coinOW4');
      spawnPickupFlagged(22*8, 30*8, 'coin',  'coinOW5');
    },
  }))(),

  // ---- Cave Level 1 (slimes) ----
  cave: (() => ({
    worldCols: CAVE_COLS, worldRows: CAVE_ROWS, bgColor: 30,
    playerStart: { tileX: 3, tileY: 8 },
    music: 'cave',
    layerBG: c1Bg, layerObjects: c1Obj, layerCollision: c1Col,
    portals: [
      { tileX: 1,  tileY: 8,  targetScene: 'overworld', targetTileX: 34, targetTileY: 8 },
      { tileX: 17, tileY: 15, targetScene: 'cave_b2',   targetTileX: 3,  targetTileY: 14,
        onActivate() { sound.playSFX('stairs'); showNote('DESCENDING TO B2...'); } },
    ],
    chests: [
      {
        tileX: 11, tileY: 6, flagName: 'chest_cave_key',
        loot: [{
          sprite: 'key_item',
          label: 'KEY OBTAINED!',
          onPickup() {
            setFlag('hasKey');
            const slot = hud.items.indexOf(null);
            if (slot >= 0) { hud.setItem(slot, 'key_item'); hud.selectedSlot = slot; }
          },
        }],
      },
      {
        tileX: 16, tileY: 14, flagName: 'chest_cave_potion',
        loot: [{
          sprite: 'potion_item',
          label: 'POTION FOUND IN THE DEPTHS!',
          onPickup() {
            const slot = hud.items.indexOf(null);
            if (slot >= 0) { hud.setItem(slot, 'potion_item'); hud.selectedSlot = slot; }
          },
        }],
      },
    ],
    npcs: [
      {
        tileX: 12, tileY: 8, sprite: 'npc_b', name: 'CAVE SAGE',
        dialog: ['...'],
        dialogBranches: [
          {
            requires: ['foundCrystal'],
            lines: ['YOU FOUND IT! RETURN\nTO THE VILLAGE AND\nTELL THE VILLAGER.'],
          },
          {
            requires: ['enteredCave', 'hasKey'],
            excludes: ['foundCrystal'],
            lines: ['THE CRYSTAL LIES\nFURTHER IN.', 'THE KEY WILL OPEN\nTHE CHAMBER.'],
          },
          {
            requires: ['enteredCave'],
            excludes: ['hasKey'],
            lines: ['A CHEST LIES TO THE\nNORTH-EAST. THE KEY\nINSIDE OPENS ALL.'],
          },
          {
            lines: ['SEEK THE CRYSTAL\nTHAT LIES WITHIN\nTHESE WALLS.',
                    'STAIRS IN THE SOUTH-EAST\nLEAD DEEPER. BEWARE\nBATS AND WORSE.'],
          },
        ],
      },
    ],
    onEnter() {
      spawnPickupFlagged(13*8, 8*8, 'coin',  'crystalCave');
      spawnPickupFlagged( 8*8,14*8, 'heart', 'heartCave');

      // Spawn slimes
      if (!getFlag('cave_cleared')) {
        spawnEnemy('slime',  7,  3);
        spawnEnemy('slime', 16,  5);
        spawnEnemy('slime',  5, 14);
      }

      if (!getFlag('enteredCave')) {
        const sageId = world.query('npcData').find(
          id => world.get(id,'npcData')?.name === 'CAVE SAGE'
        );
        if (sageId !== undefined) {
          setTimeout(() => cutscene.run(buildCaveEntryCutscene(sageId)), 80);
        }
      }
    },
  }))(),

  // ---- Cave Level 2 (bats) ----
  cave_b2: (() => ({
    worldCols: CAVE_COLS, worldRows: CAVE_ROWS, bgColor: 30,
    playerStart: { tileX: 3, tileY: 8 },
    music: 'cave',
    layerBG: c2Bg, layerObjects: c2Obj, layerCollision: c2Col,
    portals: [
      { tileX: 2,  tileY: 15, targetScene: 'cave',    targetTileX: 16, targetTileY: 14,
        onActivate() { sound.playSFX('stairs'); showNote('ASCENDING TO B1...'); } },
      { tileX: 17, tileY: 2,  targetScene: 'cave_b3', targetTileX: 16, targetTileY: 14,
        onActivate() { sound.playSFX('stairs'); showNote('DESCENDING TO B3...'); } },
    ],
    chests: [
      {
        tileX: 10, tileY: 14, flagName: 'chest_b2_heart',
        loot: [{
          sprite: 'heart_item',
          label: 'HEART CONTAINER! +2 MAX HP',
          onPickup() {
            hud.setMaxHp(hud.maxHp + 2);
            hud.addHp(2);
            sound.playSFX('heal');
            emitBurst(10*8+4, 14*8+4, 'levelup');
            showNote('+2 MAX HP!');
          },
        }],
      },
      {
        tileX: 16, tileY: 8, flagName: 'chest_b2_potion',
        loot: [{
          sprite: 'potion_item',
          label: 'POTION FOUND!',
          onPickup() {
            const slot = hud.items.indexOf(null);
            if (slot >= 0) { hud.setItem(slot, 'potion_item'); hud.selectedSlot = slot; }
          },
        }],
      },
    ],
    npcs: [],
    onEnter() {
      spawnPickupFlagged( 9*8, 3*8, 'coin',  'coinB2a');
      spawnPickupFlagged(14*8, 3*8, 'coin',  'coinB2b');
      spawnPickupFlagged( 2*8, 8*8, 'heart', 'heartB2');

      // Spawn bats — faster, more aggressive; share aggro group
      spawnEnemy('bat',  5,  3, { aggroGroup: 'cave_b2_bats' });
      spawnEnemy('bat', 14,  8, { aggroGroup: 'cave_b2_bats' });
      spawnEnemy('bat',  8, 14, { aggroGroup: 'cave_b2_bats' });
      spawnEnemy('bat', 16,  3, { aggroGroup: 'cave_b2_bats' });

      if (!getFlag('sawB2Warning')) {
        setFlag('sawB2Warning');
        showNote('B2 — BATS AHEAD! STAY ALERT.', 3.0);
      }
    },
  }))(),

  // ---- Cave Level 3 (skeletons — boss floor) ----
  cave_b3: (() => ({
    worldCols: CAVE_COLS, worldRows: CAVE_ROWS, bgColor: 14,
    playerStart: { tileX: 3, tileY: 8 },
    music: 'cave_deep',
    layerBG: c3Bg, layerObjects: c3Obj, layerCollision: c3Col,
    portals: [
      { tileX: 16, tileY: 15, targetScene: 'cave_b2', targetTileX: 16, targetTileY: 2,
        onActivate() { sound.playSFX('stairs'); showNote('ASCENDING TO B2...'); } },
    ],
    chests: [
      // Treasure chest at the boss chamber centre
      {
        tileX: 9, tileY: 8, flagName: 'chest_b3_treasure',
        loot: [
          {
            sprite: 'coin_item',
            label: 'ANCIENT GOLD! +10 COINS',
            onPickup() {
              hud.addCoins(10);
              sound.playSFX('coin');
              emitBurst(9*8+4, 8*8+4, 'coin');
              showNote('ANCIENT HOARD! +10 COINS');
            },
          },
          {
            sprite: 'heart_item',
            label: '+2 MAX HP',
            onPickup() {
              hud.setMaxHp(hud.maxHp + 2);
              hud.addHp(2);
              sound.playSFX('heal');
              showNote('+2 MAX HP FROM ANCIENT RELIC!');
            },
          },
        ],
      },
    ],
    npcs: [],
    onEnter() {
      spawnPickupFlagged( 2*8,  2*8, 'coin',  'coinB3a');
      spawnPickupFlagged(17*8,  2*8, 'coin',  'coinB3b');
      spawnPickupFlagged( 2*8, 16*8, 'coin',  'coinB3c');

      // Skeleton spawner — one skeleton every 10 seconds, always respawns.
      createSpawner({
        tileX: 9, tileY: 8,
        sprite: {
          idle:      { frames: ['skel_0', 'skel_1'], durations: 0.45 },
          walk_down: { frames: ['skel_0', 'skel_1'], durations: 0.25 },
          walk_up:   { frames: ['skel_0', 'skel_1'], durations: 0.25 },
          walk_side: { frames: ['skel_0', 'skel_1'], durations: 0.25 },
        },
        hp: 5, speed: 22,
        alertRange: 80, attackRange: 14, leashRange: 130,
        weapon: { damage: 2, knockback: 55, cooldownMax: 1.4 },
        aggroGroup: 'cave_b3_spawner',
        useLOS: false,
        onDeath(vid) {
          const tf = world.get(vid, 'transform');
          if (tf) {
            world.createEntity({
              transform: { x: tf.x, y: tf.y },
              sprite:    { name: 'heart_item', flipX: false },
              pickup:    { type: 'heart', collected: false },
            });
          }
          sound.playSFX('enemy_die');
        },
      }, { respawnDelay: 10 });

      // Add downward stairs portal object (visual only — actual portal defined below)
      // (The portal entry in cave_b3's `portals` array handles the transition)

      if (!getFlag('sawB3Warning')) {
        setFlag('sawB3Warning');
        showNote('B3 — THE DEEP. A SPAWNER STIRS\nIN THE SHADOWS.', 3.5);
      }
    },
  }))(),

  // ---- Cave Level 4 — Boss Floor ----
  cave_b4: (() => ({
    worldCols: CAVE_COLS, worldRows: CAVE_ROWS, bgColor: 14,
    playerStart: { tileX: 3, tileY: 14 },
    music: 'cave_deep',
    layerBG: c4Bg, layerObjects: c4Obj, layerCollision: c4Col,
    portals: [
      // Stairs back up to B3
      { tileX: 3, tileY: 15, targetScene: 'cave_b3', targetTileX: 2, targetTileY: 3,
        onActivate() { sound.playSFX('stairs'); showNote('ASCENDING TO B3...'); } },
      // Exit portal (locked until boss is dead)
      {
        tileX: 16, tileY: 2,
        script: [
          { cmd: 'call', fn() {
              if (!getFlag('boss_b4_dead')) {
                cutscene.run([
                  { cmd: 'dialog', name: 'SEALED DOOR',
                    lines: ['THE VOID SEALS THIS PASSAGE.', 'DEFEAT THE HERALD FIRST.'] },
                ]);
              } else {
                // Transition back to overworld as a reward
                sceneTransition('overworld', 35 * TILE_SIZE, 8 * TILE_SIZE);
              }
            }},
        ],
      },
    ],
    chests: [
      // Loot chest — only accessible after boss is dead
      {
        tileX: 9, tileY: 8, flagName: 'chest_b4_loot',
        loot: [
          {
            sprite: 'coin_item',
            label: 'VOID GOLD! +15 COINS',
            onPickup() {
              hud.addCoins(15);
              sound.playSFX('coin');
              emitBurst(9*8+4, 8*8+4, 'coin');
              showNote('+15 VOID COINS!');
            },
          },
        ],
      },
    ],
    npcs: [],
    onEnter() {
      spawnPickupFlagged( 2*8,  2*8, 'coin', 'coinB4a');
      spawnPickupFlagged(17*8,  2*8, 'coin', 'coinB4b');
      spawnPickupFlagged( 2*8, 16*8, 'heart','heartB4');

      // Reset phase state on every entry so re-visiting the floor works
      _bossPhase = 0;
      _bossId    = -1;

      if (!getFlag('boss_b4_dead')) {
        if (!getFlag('sawB4Intro')) {
          setFlag('sawB4Intro');
          // First visit — play boss intro cutscene, which spawns the boss
          setTimeout(() => cutscene.run(_buildBossIntroCutscene()), 80);
        } else {
          // Return visit — spawn boss immediately (no intro)
          spawnBoss();
        }
      } else {
        showNote('THE HERALD IS VANQUISHED.\nPEACE LINGERS HERE.');
      }
    },
  }))(),
};

registerScenes(SCENE_DATA);
setSaveKey('pixelCanvas_zelda_v51_enhanced');

// ================================================================
// QUEST WATCHERS
// ================================================================
onFlags(['hasKey', 'enteredCave'], () => {
  if (!getFlag('foundCrystal')) {
    setFlag('foundCrystal');
    showNote('YOU FOUND THE CRYSTAL!');
    sound.playSFX('confirm');
    emitBurst(13*8+4, 8*8+4, 'levelup');
  }
});

// ================================================================
// HUD SETUP
// ================================================================
hud.setMaxHp(6);
hud.setHp(6);
hud.setCoins(0);

// ================================================================
// PLAYER ENTITY
// ================================================================
setPlayerId(world.createEntity({
  persistent: true,
  player:     true,
  transform:  { x: 15 * TILE_SIZE, y: 15 * TILE_SIZE },
  velocity:   { dx: 0, dy: 0, speed: 60 },
  animator:   createAnimator(CLIPS_PLAYER, 'idle'),
  collider:   true,
  damageable: {
    hp: 6, maxHp: 6,
    iframes: 0, iframeMax: 1.5,
    team: 'player',
    onHit(vid, aid, amount) {
      // Shield passive: reduce damage by 1 if equipped
      const realDmg = getFlag('hasShield') ? Math.max(1, amount - 1) : amount;
      const dmg = world.get(vid, 'damageable');
      // Re-apply correct damage (sysDamage already applied full amount)
      if (getFlag('hasShield') && realDmg < amount) {
        dmg.hp = Math.min(dmg.maxHp, dmg.hp + (amount - realDmg));
      }
      hud.setHp(Math.max(0, dmg.hp));
      sound.playSFX('hurt');
      const tf = world.get(vid, 'transform');
      if (tf) emitBurst(tf.x + 4, tf.y + 4, 'hit');
      if (dmg.hp <= 0) showNote('DEFEATED! F9 TO RELOAD', 5.0);
    },
    onDeath() { /* handled in onHit */ },
  },
}));

registerAllItemUseHandlers();

// ================================================================
// OVERRIDE sysInput TO TRACK PLAYER FACING
// ================================================================
const _origSysInput = sysInput;
// Wrap after init by hooking into the movement update via a separate tracker
function sysTrackFacing() {
  const vel = world.get(getPlayerId(), 'velocity');
  if (!vel) return;
  if (vel.dx !== 0 || vel.dy !== 0) {
    // Normalise and store dominant axis
    if (Math.abs(vel.dx) >= Math.abs(vel.dy)) {
      playerFacing.dx = vel.dx > 0 ? 1 : -1;
      playerFacing.dy = 0;
    } else {
      playerFacing.dx = 0;
      playerFacing.dy = vel.dy > 0 ? 1 : -1;
    }
  }
}

// ================================================================
// MINIMAP TOGGLE (M key)
// ================================================================
let minimapVisible = true;
window.addEventListener('keydown', e => {
  if (e.code === 'KeyM') minimapVisible = !minimapVisible;
});

// ================================================================
// MAIN LOOP
// ================================================================
let elapsed = 0, lastTime = 0;
let fps = 0, fpsTimer = 0, fpsFrames = 0;

loadScene('overworld');
if (saveLoad.hasSave()) { if (saveLoad.load()) showNote('SAVE LOADED'); }

function loop(ts) {
  const delta = Math.min((ts - lastTime) / 1000, 0.05);
  lastTime = ts; elapsed += delta;
  fpsFrames++; fpsTimer += delta;
  if (fpsTimer >= 0.5) { fps = Math.round(fpsFrames / fpsTimer); fpsTimer = fpsFrames = 0; }

  // Engine subsystems
  engineTick(delta);
  updateTransition(delta);

  // Logic
  input.update();
  sysInput();
  sysTrackFacing();
  sysPlayerAttack(delta);
  sysAI(delta);
  sysEnemyAI(delta);
  sysEnemy(delta);       // engine AI for spawner-created enemies (B3/B4)
  sysMovement(delta);
  sysSpatialHash();
  sysCamera();
  sysSceneTransition();
  sysAnimation(delta);
  sysDialog(elapsed);
  sysDamage(delta);
  sysSpawner(delta);     // manage B3 skeleton spawner and B4 boss spawner
  sysProjectile(delta);
  sysSwing(delta);
  sysPickups();
  sysPickupFlags();
  sysChestLoot(delta);
  sysFootsteps(delta);
  sysPortalSparkles(delta);

  // Render
  clearBuffer(getScenes()[worldState.currentScene]?.bgColor ?? 0);
  drawTilemap(worldState.layerBG,      elapsed);
  drawTilemap(worldState.layerObjects, elapsed);
  sysRender();
  renderParticles();
  renderHUD();
  if (minimapVisible) {
    renderMinimap({
      corner:     'bottomRight',
      fixedMapW:  42,
      fixedMapH:  38,
      showCamera: true,
    });
  }
  renderDialog(elapsed);
  renderSaveNote();
  flushBuffer();
  renderTransitionOverlay();

  // Debug overlay
  const ptf = world.get(getPlayerId(), 'transform');
  document.getElementById('debug').textContent =
    `FPS: ${fps}  SCENE: ${worldState.currentScene}\n` +
    `PLAYER: ${ptf?.x|0},${ptf?.y|0}  FACING: ${playerFacing.dx},${playerFacing.dy}\n` +
    `CAM: ${camera.x},${camera.y}  WORLD: ${worldState.w}x${worldState.h}px\n` +
    `FLAGS: met=${+getFlag('metVillager')} cave=${+getFlag('enteredCave')} ` +
    `key=${+getFlag('hasKey')} crystal=${+getFlag('foundCrystal')} rew=${+getFlag('rewarded')} shield=${+getFlag('hasShield')}\n` +
    `HP: ${hud.hp}/${hud.maxHp}  COINS: ${hud.coins}  ` +
    `SLOT: ${hud.selectedSlot ?? 'none'}  ITEMS: [${hud.items.map(i=>i?i.replace('_item',''):'-').join('|')}]\n` +
    `WEAPON: ${hud.selectedSlot !== null && hud.items[hud.selectedSlot] ? hud.items[hud.selectedSlot].replace('_item','').toUpperCase() : 'BASIC SWORD'}\n` +
    `ATTACK_CD: ${attackCooldown.toFixed(2)}  ENEMIES: ${world.query('enemy').length}`;

  requestAnimationFrame(loop);
}

requestAnimationFrame(loop);
</script>
</body>
</html>